/**
 * @license
 * Copyright (C) 2018 Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
!function(i,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/common"),require("@angular/core"),require("@angular/forms"),require("@angular/cdk/drag-drop"),require("@angular/material/autocomplete"),require("@angular/material/button"),require("@angular/material/card"),require("@angular/material/checkbox"),require("@angular/material/chips"),require("@angular/material/dialog"),require("@angular/material/form-field"),require("@angular/material/icon"),require("@angular/material/input"),require("@angular/material/list"),require("@angular/material/menu"),require("@angular/material/select"),require("@angular/material/sidenav"),require("@angular/material/slider"),require("@angular/material/table"),require("@angular/material/toolbar"),require("@angular/material/tooltip"),require("@ngx-translate/core"),require("@ajf/material/monaco-editor"),require("@ajf/material/node-icon"),require("rxjs/operators"),require("@ajf/core/forms"),require("@angular/cdk/collections"),require("rxjs"),require("@ajf/core/models"),require("@ajf/core/utils"),require("@angular/cdk/keycodes")):"function"==typeof define&&define.amd?define("@ajf/material/form-builder",["exports","@angular/common","@angular/core","@angular/forms","@angular/cdk/drag-drop","@angular/material/autocomplete","@angular/material/button","@angular/material/card","@angular/material/checkbox","@angular/material/chips","@angular/material/dialog","@angular/material/form-field","@angular/material/icon","@angular/material/input","@angular/material/list","@angular/material/menu","@angular/material/select","@angular/material/sidenav","@angular/material/slider","@angular/material/table","@angular/material/toolbar","@angular/material/tooltip","@ngx-translate/core","@ajf/material/monaco-editor","@ajf/material/node-icon","rxjs/operators","@ajf/core/forms","@angular/cdk/collections","rxjs","@ajf/core/models","@ajf/core/utils","@angular/cdk/keycodes"],t):t(((i=i||self).ajf=i.ajf||{},i.ajf.material=i.ajf.material||{},i.ajf.material.formBuilder={}),i.ng.common,i.ng.core,i.ng.forms,i.ng.cdk.dragDrop,i.ng.material.autocomplete,i.ng.material.button,i.ng.material.card,i.ng.material.checkbox,i.ng.material.chips,i.ng.material.dialog,i.ng.material.formField,i.ng.material.icon,i.ng.material.input,i.ng.material.list,i.ng.material.menu,i.ng.material.select,i.ng.material.sidenav,i.ng.material.slider,i.ng.material.table,i.ng.material.toolbar,i.ng.material.tooltip,i.ngxt.core,i.ajf.material.monacoEditor,i.ajf.material.nodeIcon,i.rxjs.operators,i.ajf.core.forms,i.ng.cdk.collections,i.rxjs,i.ajf.core.models,i.ajf.core.utils,i.ng.cdk.keycodes)}(this,function(i,t,o,j,e,n,r,a,s,l,d,c,u,p,f,h,m,g,b,v,_,y,C,S,E,D,F,x,O,w,N,T){"use strict";var V=function(i,t){return(V=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,t){i.__proto__=t}||function(i,t){for(var e in t)t.hasOwnProperty(e)&&(i[e]=t[e])})(i,t)};var M=function(){return(M=Object.assign||function(i){for(var t,e=1,n=arguments.length;e<n;e++)for(var o in t=arguments[e])Object.prototype.hasOwnProperty.call(t,o)&&(i[o]=t[o]);return i}).apply(this,arguments)},P=(Object.defineProperty(I.prototype,"offset",{set:function(i){this._offset=i,this._updateOffset()},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,"color",{set:function(i){this._color=i,this._updateColor()},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,"height",{set:function(i){this._height=i,this._updateHeight()},enumerable:!0,configurable:!0}),I.prototype._updateHeight=function(){var i=Math.max(0,this._height-25)+"px";this._renderer.setStyle(this._el.nativeElement,"height",i)},I.prototype._updateOffset=function(){var i=4*this._offset+"px";this._renderer.setStyle(this._el.nativeElement,"margin-top",i),this._renderer.setStyle(this._el.nativeElement,"margin-left",i)},I.prototype._updateColor=function(){this._renderer.setStyle(this._el.nativeElement,"border-color",this._color)},I.decorators=[{type:o.Component,args:[{selector:"ajf-fb-branch-line",template:"",styles:["ajf-fb-branch-line{display:block;position:absolute;top:25px;left:25px;width:25px;border-top:2px solid;border-left:2px solid;border-top-left-radius:6px}"],encapsulation:o.ViewEncapsulation.None,changeDetection:o.ChangeDetectionStrategy.OnPush}]}],I.ctorParameters=function(){return[{type:o.ElementRef},{type:o.Renderer2}]},I.propDecorators={offset:[{type:o.Input}],color:[{type:o.Input}],height:[{type:o.Input}]},I);function I(i,t){this._el=i,this._renderer=t,this._offset=0,this._height=0}var R,k,A,B=(A=x.DataSource,V(R=W,k=A),void(R.prototype=null===k?Object.create(k):(L.prototype=k.prototype,new L)),W.prototype.connect=function(){return this._choicesObs},W.prototype.disconnect=function(){},W.prototype.updateChoices=function(i){this._choices.next(i)},W);function L(){this.constructor=R}function W(){var i=A.call(this)||this;return i._choices=new O.BehaviorSubject([]),i._choicesObs=i._choices.asObservable(),i}var Y=(Object.defineProperty(U.prototype,"displayedColumns",{get:function(){return this._displayedColumns},enumerable:!0,configurable:!0}),Object.defineProperty(U.prototype,"choicesOrigin",{get:function(){return this._choicesOrigin},set:function(i){this._choicesOrigin=i,this.name=i.name,this.label=i.label,this.canEditChoices=F.isChoicesFixedOrigin(i),this._choicesArr=i.choices,this._choices.updateChoices(this._choicesArr)},enumerable:!0,configurable:!0}),Object.defineProperty(U.prototype,"choices",{get:function(){return this._choices},enumerable:!0,configurable:!0}),Object.defineProperty(U.prototype,"choicesArr",{get:function(){return this._choicesArr},enumerable:!0,configurable:!0}),U.prototype.updateValue=function(i,t,e,n){this.editing[n+"-"+t]=!1,this._choicesArr[n][t]=i.target.value,this._choices.updateChoices(this._choicesArr)},U.prototype.deleteRow=function(i){this._choicesArr.splice(i,1),this._choices.updateChoices(this._choicesArr)},U.prototype.addRow=function(){this._choicesArr.push({label:"",value:""}),this._choices.updateChoices(this._choicesArr)},U.decorators=[{type:o.Component,args:[{selector:"ajf-fb-choices-origin-editor",template:'<div><mat-form-field><input matInput [(ngModel)]="name" [placeholder]="\'Name\' | translate"></mat-form-field><mat-form-field><input matInput [(ngModel)]="label" [placeholder]="\'Label\' | translate"></mat-form-field><ng-template [ngIf]="canEditChoices"><button (click)="addRow()" mat-button><mat-icon>add</mat-icon><span translate>Add value</span></button><mat-table [dataSource]="choices"><ng-container matColumnDef="label"><mat-header-cell *matHeaderCellDef translate>Label</mat-header-cell><mat-cell *matCellDef="let row; let idx = index"><input matInput [(ngModel)]="row.label" type="text"></mat-cell></ng-container><ng-container matColumnDef="value"><mat-header-cell *matHeaderCellDef translate>Value</mat-header-cell><mat-cell *matCellDef="let row; let idx = index"><input matInput [(ngModel)]="row.value" type="text"></mat-cell></ng-container><ng-container matColumnDef="delete"><mat-header-cell *matHeaderCellDef translate>Delete</mat-header-cell><mat-cell *matCellDef="let row; let idx = index"><mat-icon (click)="deleteRow(idx)">delete</mat-icon></mat-cell></ng-container><mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row><mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row></mat-table></ng-template></div>',styles:["ajf-fb-choices-origin-editor mat-form-field+mat-form-field{margin-left:1em}ajf-fb-choices-origin-editor mat-table{max-height:300px}ajf-fb-choices-origin-editor mat-table mat-icon{cursor:pointer}"],encapsulation:o.ViewEncapsulation.None,changeDetection:o.ChangeDetectionStrategy.OnPush}]}],U.propDecorators={choicesOrigin:[{type:o.Input}]},U);function U(){this._displayedColumns=["label","value","delete"],this.editing={},this._choices=new B,this._choicesArr=[]}function q(i,t){if(-1<i.nodes.indexOf(t))return i;for(var e=i.nodes.filter(function(i){return F.isContainerNode(i)}),n=e.length,o=0;o<n;o++){var r=q(e[o],t);if(null!=r)return r}return null}function z(e,t,i){void 0===i&&(i=!1);var n=e.filter(function(i){return i.parent===t.id}).sort(function(i,t){return i.parentNode-t.parentNode}).map(function(i){var t=z(e,i);return 0===t.length&&t.push({parent:i,parentNode:0}),{node:i,children:t,content:H(e,i)}});if(!i)for(var o=n.length,r=t.conditionalBranches.length,a=o;a<r;a++)n.push({parent:t,parentNode:a});return n}function H(i,t){return F.isContainerNode(t)?z(t.nodes,t,!0):[]}function $(i){var t=[];return i.forEach(function(i){F.isContainerNode(i)&&(t=t.concat($(i.nodes))),t.push(i)}),t}function J(i,t,e){return void 0===e&&(e=null),null!=e?i.filter(function(i){return i.parent===t.id&&i.parentNode===e}):i.filter(function(i){return i.parent===t.id})}function Z(i,t,e){void 0===e&&(e=null);for(var n=$(i),o=[],r=J(n,t,e),a=r.length,s=0;s<a;s++)o=o.concat(J(n,r[s]));return function i(t,e){for(var n=t.length,o=0;o<n;o++){var r=t[o];if(F.isContainerNode(r)){var a=r;a.nodes=i(a.nodes,e)}}return t.filter(function(i){return-1===e.indexOf(i.id)})}(i,(o=o.concat(r)).map(function(i){return i.id}))}var G=0,K=(Object.defineProperty(Q.prototype,"availableNodeTypes",{get:function(){return this._availableNodeTypes},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"form",{get:function(){return this._formObs},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"attachmentsOrigins",{get:function(){return this._attachmentsOrigins},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"choicesOrigins",{get:function(){return this._choicesOrigins},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"stringIdentifier",{get:function(){return this._stringIdentifier},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"nodes",{get:function(){return this._nodes},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"flatNodes",{get:function(){return this._flatNodes},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"flatFields",{get:function(){return this._flatFields},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"nodeEntriesTree",{get:function(){return this._nodeEntriesTree},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"editedNodeEntry",{get:function(){return this._editedNodeEntryObs},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"editedCondition",{get:function(){return this._editedConditionObs},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"editedChoicesOrigin",{get:function(){return this._editedChoicesOriginObs},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"beforeNodesUpdate",{get:function(){return this._beforeNodesUpdateObs},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"afterNodeUpdate",{get:function(){return this._afterNodeUpdateObs},enumerable:!0,configurable:!0}),Q.prototype.setForm=function(i){i!==this._form.getValue()&&this._form.next(i)},Q.prototype.editNodeEntry=function(i){this._editedNodeEntry.next(i)},Q.prototype.editCondition=function(i){this._editedCondition.next(i)},Q.prototype.saveCurrentCondition=function(i){var t=this._editedCondition.getValue();null!=t&&(t.condition=i,this._editedCondition.next(null))},Q.prototype.cancelConditionEdit=function(){this._editedChoicesOrigin.next(null)},Q.prototype.insertNode=function(i,o,t,r){var a;void 0===r&&(r=!1);var e=++G,s=null!=i.nodeType.field;a=s?F.createField({id:e,nodeType:F.AjfNodeType.AjfField,fieldType:i.nodeType.field,parent:o.id,parentNode:t,name:""}):F.createContainerNode({id:e,nodeType:i.nodeType.node,parent:null!=o?o.id:0,parentNode:t,name:"",nodes:[]}),this._beforeNodesUpdate.emit(),this._nodesUpdates.next(function(i){if(0===a.parent)return[a];var t=F.isContainerNode(o)&&r?o:q({nodes:i},o);if(null!=t)if(s)t.nodes.push(a);else{var e=t.nodes===i,n=t.nodes.slice(0);n.push(a),t.nodes=n,e&&(i=n)}return i})},Q.prototype.saveNodeEntry=function(i){this._saveNodeEntryEvent.emit(i)},Q.prototype.cancelNodeEntryEdit=function(){this._editedNodeEntry.next(null)},Q.prototype.deleteNodeEntry=function(i){this._deleteNodeEntryEvent.next(i)},Q.prototype.getCurrentForm=function(){return O.combineLatest([this.form,this.nodes,this.attachmentsOrigins,this.choicesOrigins,this.stringIdentifier]).pipe(D.filter(function(i){return null!=i[0]}),D.map(function(i){var t=i[0],e=i[1],n=i[2],o=i[3],r=i[4];return F.createForm({choicesOrigins:o.slice(0),attachmentsOrigins:n.slice(0),stringIdentifier:(r||[]).slice(0),nodes:e.slice(0),supplementaryInformations:t.supplementaryInformations})}))},Q.prototype.editChoicesOrigin=function(i){this._editedChoicesOrigin.next(i)},Q.prototype.createChoicesOrigin=function(){this._editedChoicesOrigin.next(F.createChoicesFixedOrigin({name:""}))},Q.prototype.cancelChoicesOriginEdit=function(){this._editedChoicesOrigin.next(null)},Q.prototype.saveChoicesOrigin=function(i){var e=this._editedChoicesOrigin.getValue();null!=e&&(e.label=i.label,e.name=i.name,F.isChoicesFixedOrigin(e)&&(e.choices=i.choices),this._choicesOriginsUpdates.next(function(i){var t=i.indexOf(e);return i=-1<t?i.slice(0,t).concat([e],i.slice(t+1)):i.concat([e])})),this._editedChoicesOrigin.next(null)},Q.prototype.saveStringIdentifier=function(i){this._stringIdentifierUpdates.next(function(){return i.slice()})},Q.prototype._findMaxNodeId=function(i,t){var e=this,n=0;return i.forEach(function(i){n=Math.max(n,i.id),F.isContainerNode(i)&&(n=Math.max(n,e._findMaxNodeId(i.nodes)))}),n},Q.prototype._initFormStreams=function(){var i=this;this._form.subscribe(function(t){G=0,null!=t&&null!=t.nodes&&0<t.nodes.length&&(G=i._findMaxNodeId(t.nodes)),i._nodesUpdates.next(function(i){return null!=t&&null!=t.nodes?t.nodes.slice(0):[]}),i._attachmentsOriginsUpdates.next(function(i){return null!=t&&null!=t.attachmentsOrigins?t.attachmentsOrigins.slice(0):[]}),i._choicesOriginsUpdates.next(function(i){return null!=t&&null!=t.choicesOrigins?t.choicesOrigins.slice(0):[]}),i._stringIdentifierUpdates.next(function(i){return null!=t&&null!=t.stringIdentifier?t.stringIdentifier.slice(0):[]})})},Q.prototype._initChoicesOriginsStreams=function(){this._choicesOrigins=this._choicesOriginsUpdates.pipe(D.scan(function(i,t){return t(i)},[]),D.publishReplay(1),D.refCount())},Q.prototype._initAttachmentsOriginsStreams=function(){this._attachmentsOrigins=this._attachmentsOriginsUpdates.pipe(D.scan(function(i,t){return t(i)},[]),D.publishReplay(1),D.refCount())},Q.prototype._initStringIdentifierStreams=function(){this._stringIdentifier=this._stringIdentifierUpdates.pipe(D.scan(function(i,t){return t(i)},[]),D.publishReplay(1),D.refCount())},Q.prototype._initNodesStreams=function(){this._nodes=this._nodesUpdates.pipe(D.scan(function(i,t){return t(i)},[]),D.publishReplay(1),D.refCount()),this._flatNodes=this._nodes.pipe(D.map(function(i){return $(i)}),D.publishReplay(1),D.refCount()),this._flatFields=this._flatNodes.pipe(D.map(function(i){return i.filter(function(i){return!F.isContainerNode(i)})}),D.publishReplay(1),D.refCount()),this._nodeEntriesTree=this._nodes.pipe(D.map(function(i){return function(i){var t=i.filter(function(i){return null==i.parent||0===i.parent});if(1===t.length){var e=t[0];if(F.isSlidesNode(e)){var n=[];return n.push({node:e,container:null,children:z(i,e),content:H(0,e)}),n}}else if(0===t.length)return[null];throw new Error("Invalid form definition")}(i)}),D.publishReplay(1),D.refCount())},Q.prototype._initSaveNode=function(){var C=this;this._saveNodeEntryEvent.pipe(D.withLatestFrom(this.editedNodeEntry,this.choicesOrigins,this.attachmentsOrigins),D.filter(function(i){return i[0],null!=i[1]}),D.map(function(i){var t=i[0],e=i[1];C._beforeNodesUpdate.emit();var a=(e=e).node,s=N.deepCopy(a);s.id=e.node.id,s.name=t.name,s.label=t.label,s.visibility=null!=t.visibility?w.createCondition({condition:t.visibility}):null;var l=s.conditionalBranches.length;s.conditionalBranches=null!=t.conditionalBranches?t.conditionalBranches.map(function(i){return w.createCondition({condition:i})}):[w.alwaysCondition()];var d=s.conditionalBranches.length;if(F.isRepeatingContainerNode(s)){var n=s;n.formulaReps=null!=t.formulaReps?w.createFormula({formula:t.formulaReps}):void 0,n.minReps=t.minReps,n.maxReps=t.maxReps}if(F.isField(s)){var o=s;o.description=t.description,o.defaultValue=t.defaultValue,o.formula=null!=t.formula?w.createFormula({formula:t.formula}):void 0;var r=t.value,c=t.notEmpty,u=t.validationConditions,p=parseInt(t.minValue,10),f=parseInt(t.maxValue,10),h=parseInt(t.minDigits,10),m=parseInt(t.maxDigits,10);if(isNaN(p)&&(p=null),isNaN(f)&&(f=null),isNaN(h)&&(h=null),isNaN(m)&&(m=null),null!=r||null!=c||null!=u&&0<u.length||null!=p||null!=f||null!=h||null!=m){var g=o.validation||F.createValidationGroup({});g.forceValue=r,g.notEmpty=c?F.notEmptyValidation():void 0,g.minValue=null!=p?F.minValidation(p):void 0,g.maxValue=null!=f?F.maxValidation(f):void 0,g.minDigits=null!=h?F.minDigitsValidation(h):void 0,g.maxDigits=null!=m?F.maxDigitsValidation(m):void 0,g.conditions=(u||[]).map(function(i){return F.createValidation({condition:i.condition,errorMessage:i.errorMessage})}),o.validation=g}else o.validation=void 0;var b=t.notEmptyWarning,v=t.warningConditions;if(null!=b||null!=v&&0<v.length){var _=o.warning||F.createWarningGroup({});_.notEmpty=b?F.notEmptyWarning():void 0,_.conditions=(v||[]).map(function(i){return F.createWarning({condition:i.condition,warningMessage:i.warningMessage})}),o.warning=_}else o.warning=void 0;if(o.nextSlideCondition=null!=t.nextSlideCondition?w.createCondition({condition:t.nextSlideCondition}):void 0,o.size=t.size,o.defaultValue=t.defaultValue,F.isFieldWithChoices(o)){var y=o;y.choicesOriginRef=t.choicesOriginRef,y.forceExpanded=t.forceExpanded,y.forceNarrow=t.forceNarrow,y.triggerConditions=(t.triggerConditions||[]).map(function(i){return w.createCondition({condition:i})})}}return C._editedNodeEntry.next(null),function(i){var t=q({nodes:i},a);if(null!=t){var e=t.nodes===i,n=t.nodes.indexOf(a),o=t.nodes.slice(0,n);if(o.push(s),o=o.concat(t.nodes.slice(n+1)),t.nodes=o,i=e?o:i.slice(0),d<l)for(var r=d;r<l;r++)i=Z(i,s,r)}return i}})).subscribe(this._nodesUpdates)},Q.prototype._initDeleteNode=function(){var i=this;this._deleteNodeEntryEvent.pipe(D.map(function(a){return i._beforeNodesUpdate.emit(),function(i){var t=a.node,e=q({nodes:i},t);if(null!=e){var n=e.nodes===i,o=e.nodes.indexOf(t),r=e.nodes.slice(0,o);r=r.concat(e.nodes.slice(o+1)),e.nodes=r,i=Z(i=n?r:i.slice(0),t)}return i}})).subscribe(this._nodesUpdates)},Q.decorators=[{type:o.Injectable}],Q.ctorParameters=function(){return[]},Q);function Q(){this._availableNodeTypes=[{label:"Slide",icon:{fontSet:"ajf-icon",fontIcon:"field-slide"},nodeType:{node:F.AjfNodeType.AjfSlide},isSlide:!0},{label:"Repeating slide",icon:{fontSet:"ajf-icon",fontIcon:"field-repeatingslide"},nodeType:{node:F.AjfNodeType.AjfRepeatingSlide},isSlide:!0},{label:"String",icon:{fontSet:"ajf-icon",fontIcon:"field-string"},nodeType:{node:F.AjfNodeType.AjfField,field:F.AjfFieldType.String}},{label:"Text",icon:{fontSet:"ajf-icon",fontIcon:"field-text"},nodeType:{node:F.AjfNodeType.AjfField,field:F.AjfFieldType.Text}},{label:"Number",icon:{fontSet:"ajf-icon",fontIcon:"field-number"},nodeType:{node:F.AjfNodeType.AjfField,field:F.AjfFieldType.Number}},{label:"Boolean",icon:{fontSet:"ajf-icon",fontIcon:"field-boolean"},nodeType:{node:F.AjfNodeType.AjfField,field:F.AjfFieldType.Boolean}},{label:"Single choice",icon:{fontSet:"ajf-icon",fontIcon:"field-singlechoice"},nodeType:{node:F.AjfNodeType.AjfField,field:F.AjfFieldType.SingleChoice}},{label:"Multiple choice",icon:{fontSet:"ajf-icon",fontIcon:"field-multiplechoice"},nodeType:{node:F.AjfNodeType.AjfField,field:F.AjfFieldType.MultipleChoice}},{label:"Formula",icon:{fontSet:"ajf-icon",fontIcon:"field-formula"},nodeType:{node:F.AjfNodeType.AjfField,field:F.AjfFieldType.Formula}},{label:"Date",icon:{fontSet:"ajf-icon",fontIcon:"field-date"},nodeType:{node:F.AjfNodeType.AjfField,field:F.AjfFieldType.Date}},{label:"Date input",icon:{fontSet:"ajf-icon",fontIcon:"field-dateinput"},nodeType:{node:F.AjfNodeType.AjfField,field:F.AjfFieldType.DateInput}},{label:"Time",icon:{fontSet:"ajf-icon",fontIcon:"field-time"},nodeType:{node:F.AjfNodeType.AjfField,field:F.AjfFieldType.Time}},{label:"Table",icon:{fontSet:"ajf-icon",fontIcon:"field-table"},nodeType:{node:F.AjfNodeType.AjfField,field:F.AjfFieldType.Table}}],this._form=new O.BehaviorSubject(null),this._formObs=this._form.asObservable(),this._editedNodeEntry=new O.BehaviorSubject(null),this._editedNodeEntryObs=this._editedNodeEntry.asObservable(),this._editedCondition=new O.BehaviorSubject(null),this._editedConditionObs=this._editedCondition.asObservable(),this._editedChoicesOrigin=new O.BehaviorSubject(null),this._editedChoicesOriginObs=this._editedChoicesOrigin.asObservable(),this._beforeNodesUpdate=new o.EventEmitter,this._beforeNodesUpdateObs=this._beforeNodesUpdate.asObservable(),this._afterNodeUpdate=new o.EventEmitter,this._afterNodeUpdateObs=this._afterNodeUpdate.asObservable(),this._nodesUpdates=new O.Subject,this._attachmentsOriginsUpdates=new O.Subject,this._choicesOriginsUpdates=new O.Subject,this._stringIdentifierUpdates=new O.Subject,this._saveNodeEntryEvent=new o.EventEmitter,this._deleteNodeEntryEvent=new o.EventEmitter,this._initChoicesOriginsStreams(),this._initAttachmentsOriginsStreams(),this._initStringIdentifierStreams(),this._initNodesStreams(),this._initFormStreams(),this._initSaveNode(),this._initDeleteNode()}var X=(Object.defineProperty(ii.prototype,"choicesOrigin",{get:function(){return this._choicesOrigin},enumerable:!0,configurable:!0}),ii.prototype.saveChoicesOrigin=function(){this._service.saveChoicesOrigin({label:this.editor.label,name:this.editor.name,choices:this.editor.choicesArr})},ii.prototype.cancelChoicesOriginEdit=function(){this._service.cancelChoicesOriginEdit()},ii.decorators=[{type:o.Component,args:[{selector:"ajf-fb-choices-origin-editor-dialog",template:'<h3 matDialogTitle translate>Edit choices origin</h3><mat-dialog-content><ajf-fb-choices-origin-editor [choicesOrigin]="choicesOrigin|async"></ajf-fb-choices-origin-editor></mat-dialog-content><mat-dialog-actions><button mat-button translate (click)="saveChoicesOrigin()">Save</button> <button mat-button translate (click)="cancelChoicesOriginEdit()">Close</button></mat-dialog-actions>',styles:[""],encapsulation:o.ViewEncapsulation.None,changeDetection:o.ChangeDetectionStrategy.OnPush}]}],ii.ctorParameters=function(){return[{type:K}]},ii.propDecorators={editor:[{type:o.ViewChild,args:[Y,{static:!0}]}]},ii);function ii(i){this._service=i,this._choicesOrigin=this._service.editedChoicesOrigin.pipe(D.filter(function(i){return null!=i}),D.map(function(i){return i}))}var ti=(Object.defineProperty(ei.prototype,"fields",{get:function(){return this._fields},set:function(i){this._fields=i,this._updateVariables()},enumerable:!0,configurable:!0}),ei.prototype.insertVariable=function(i){if(null!=this.monacoEditor&&null!=this.monacoEditor.editor){var t=this.monacoEditor.editor,e=t.getValue().split("\n"),n=t.getPosition(),o=n.lineNumber-1,r=e[o],a=n.column-1;r=r.substring(0,a)+i+r.substring(a),e[o]=r,n.column+=i.length,this.monacoEditor.value=e.join("\n"),t.setPosition(n),t.focus(),this.editedValue=t.getValue()}},ei.prototype.onEditorInit=function(){monaco.languages.typescript.javascriptDefaults.setDiagnosticsOptions({noSemanticValidation:!1,noSyntaxValidation:!1}),monaco.languages.typescript.javascriptDefaults.setCompilerOptions({target:monaco.languages.typescript.ScriptTarget.ES2015,allowNonTsExtensions:!0,allowJs:!0,module:monaco.languages.typescript.ModuleKind.None});try{monaco.languages.typescript.javascriptDefaults.addExtraLib("","condition-editor-variables.d.ts")}catch(i){monaco.languages.typescript.javascriptDefaults._extraLibs["condition-editor-variables.d.ts"]=""}try{monaco.languages.typescript.javascriptDefaults.addExtraLib("","condition-editor-functions.d.ts")}catch(i){monaco.languages.typescript.javascriptDefaults._extraLibs["condition-editor-functions.d.ts"]=""}this._updateVariables(),this._updateFunctions()},ei.prototype._updateVariables=function(){var t=this;if(null!=this._fields)try{monaco.languages.typescript.javascriptDefaults._extraLibs["condition-editor-variables.d.ts"]=this._fields.map(function(i){return"declare const "+i.name+": "+t._fieldVarType(i.fieldType)+";"}).join("\n")}catch(i){}},ei.prototype._updateFunctions=function(){try{monaco.languages.typescript.javascriptDefaults._extraLibs["condition-editor-functions.d.ts"]=w.AjfExpressionUtils.UTIL_FUNCTIONS}catch(i){}},ei.prototype._fieldVarType=function(i){switch(i){case F.AjfFieldType.Boolean:return"boolean";case F.AjfFieldType.Date:case F.AjfFieldType.DateInput:case F.AjfFieldType.Time:return"Date";case F.AjfFieldType.Empty:return"void";case F.AjfFieldType.Formula:return"number";case F.AjfFieldType.MultipleChoice:case F.AjfFieldType.SingleChoice:return"any";case F.AjfFieldType.Number:return"number";case F.AjfFieldType.Table:return"Array";case F.AjfFieldType.String:case F.AjfFieldType.Text:return"string"}return null},ei.decorators=[{type:o.Component,args:[{selector:"ajf-condition-editor",template:'<div class="ajf-editor"><ajf-monaco-editor (init)="onEditorInit()" (valueChange)="editedValue = $event" [value]="condition" language="javascript"></ajf-monaco-editor></div><div class="ajf-editor-panel"><mat-nav-list dense *ngIf="fields?.length > 0"><a mat-list-item (click)="insertVariable(field.name)" [matTooltip]="field.label" *ngFor="let field of fields"><ajf-node-icon [node]="field"></ajf-node-icon>{{ field.name }}</a></mat-nav-list></div>',styles:["ajf-condition-editor{display:flex;flex-direction:row;align-items:stretch;max-height:512px}ajf-condition-editor .ajf-editor{flex:.75 0 auto;display:flex;flex-direction:row;align-items:stretch}ajf-condition-editor .ajf-editor monaco-editor{flex:1 0 auto;min-width:512px;min-height:256px}ajf-condition-editor .ajf-editor-panel{flex:.25 0 auto;overflow-y:auto}ajf-condition-editor ajf-monaco-editor{min-width:400px}"],changeDetection:o.ChangeDetectionStrategy.OnPush,encapsulation:o.ViewEncapsulation.None}]}],ei.ctorParameters=function(){return[{type:F.AjfValidationService}]},ei.propDecorators={monacoEditor:[{type:o.ViewChild,args:[S.AjfMonacoEditor,{static:!0}]}],fields:[{type:o.Input}],condition:[{type:o.Input}]},ei);function ei(i){}var ni=(Object.defineProperty(oi.prototype,"fields",{get:function(){return this._fields},enumerable:!0,configurable:!0}),oi.prototype.saveCondition=function(){if(null!=this.editor){var i=this.editor.editedValue;this.dialogRef.close(i)}},oi.decorators=[{type:o.Component,args:[{selector:"ajf-condition-editor-dialog",template:'<h3 matDialogTitle translate>Edit condition</h3><mat-dialog-content><ajf-condition-editor [fields]="fields|async" [condition]="condition"></ajf-condition-editor></mat-dialog-content><mat-dialog-actions><button mat-button translate (click)="saveCondition()">Save</button> <button mat-button translate matDialogClose>Close</button></mat-dialog-actions>',styles:["ajf-condition-editor-dialog mat-dialog-content{overflow:visible}"],encapsulation:o.ViewEncapsulation.None,changeDetection:o.ChangeDetectionStrategy.OnPush}]}],oi.ctorParameters=function(){return[{type:K},{type:d.MatDialogRef}]},oi.propDecorators={editor:[{type:o.ViewChild,args:[ti,{static:!0}]}]},oi);function oi(i,t){this.dialogRef=t,this._fields=i.flatFields.pipe(D.map(function(i){return i.sort(function(i,t){return i.name.localeCompare(t.name)})}))}var ri=(ai.prototype.addRow=function(){this.dataSource.data=this.dataSource.data.concat([{label:"",value:[]}])},ai.prototype.deleteRow=function(i){this.dataSource.data=this.dataSource.data.slice(0,i).concat(this.dataSource.data.slice(i+1))},ai.prototype.addValue=function(i,t,e){0!==t.value.length&&(i.value=i.value.concat([t.value]),e.value="",this._cdr.markForCheck())},ai.prototype.removeValue=function(i,t){var e=i.value.indexOf(t);-1<e&&(i.value=i.value.slice(0,e).concat(i.value.slice(e+1)),this._cdr.markForCheck())},ai.prototype.ngOnDestroy=function(){this._stringIdentifierSub.unsubscribe()},ai.prototype.saveStringIdentifier=function(){this._service.saveStringIdentifier(this.dataSource.data)},ai.prototype.selected=function(i,t){i.value=i.value.concat([t.option.value]),this._cdr.markForCheck()},ai.decorators=[{type:o.Component,args:[{selector:"ajf-fb-string-identifier-dialog",template:'<h3 matDialogTitle translate>Edit identifier</h3><mat-dialog-content><button (click)="addRow()" mat-button><mat-icon>add</mat-icon><span translate>Add value</span></button><mat-table [dataSource]="dataSource"><ng-container matColumnDef="label"><mat-header-cell *matHeaderCellDef translate>Label</mat-header-cell><mat-cell *matCellDef="let row; let idx = index"><mat-form-field><input matInput [placeholder]="\'Label\'|translate" autofocus [(ngModel)]="row.label"></mat-form-field></mat-cell></ng-container><ng-container matColumnDef="value"><mat-header-cell *matHeaderCellDef translate>Value</mat-header-cell><mat-cell *matCellDef="let row; let idx = index"><mat-form-field><mat-chip-list #chipList><mat-chip *ngFor="let field of row.value" (removed)="removeValue(row, field)">{{ field }}<mat-icon matChipRemove>cancel</mat-icon></mat-chip></mat-chip-list><input #valueInput [ngModel]="row.value" [matAutocomplete]="valueAc" [matChipInputFor]="chipList" [matChipInputSeparatorKeyCodes]="separatorKeysCodes" [matChipInputAddOnBlur]="true" (matChipInputTokenEnd)="addValue(row, $event, valueInput)" [placeholder]="\'Value\'|translate"><mat-autocomplete #valueAc="matAutocomplete" (optionSelected)="selected(row, $event)"><mat-option *ngFor="let field of fields$ | async" [value]="field">{{field}}</mat-option></mat-autocomplete></mat-form-field></mat-cell></ng-container><ng-container matColumnDef="delete"><mat-header-cell *matHeaderCellDef translate>Delete</mat-header-cell><mat-cell *matCellDef="let row; let idx = index"><mat-icon (click)="deleteRow(idx)">delete</mat-icon></mat-cell></ng-container><mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row><mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row></mat-table></mat-dialog-content><mat-dialog-actions><button mat-button translate matDialogClose (click)="saveStringIdentifier()">Save</button></mat-dialog-actions>',styles:[""],changeDetection:o.ChangeDetectionStrategy.OnPush,encapsulation:o.ViewEncapsulation.None}]}],ai.ctorParameters=function(){return[{type:K},{type:o.ChangeDetectorRef}]},ai);function ai(i,t){var e=this;this._service=i,this._cdr=t,this.dataSource=new v.MatTableDataSource,this.displayedColumns=["label","value","delete"],this.separatorKeysCodes=[T.ENTER,T.COMMA],this._stringIdentifierSub=O.Subscription.EMPTY,this._stringIdentifierSub=i.stringIdentifier.subscribe(function(i){e.dataSource.data=i.slice()}),this.fields$=i.flatFields.pipe(D.map(function(i){return i.sort(function(i,t){return i.name.localeCompare(t.name)}).map(function(i){return i.name}).filter(function(i){return 0<i.length})}),D.shareReplay(1))}var si=(Object.defineProperty(li.prototype,"form",{get:function(){return this._form},set:function(i){this._form!==i&&(this._form=i,this._init&&this._setCurrentForm())},enumerable:!0,configurable:!0}),Object.defineProperty(li.prototype,"nodeTypes",{get:function(){return this._nodeTypes},enumerable:!0,configurable:!0}),Object.defineProperty(li.prototype,"nodeEntriesTree",{get:function(){return this._nodeEntriesTree},enumerable:!0,configurable:!0}),Object.defineProperty(li.prototype,"choicesOrigins",{get:function(){return this._choicesOrigins},enumerable:!0,configurable:!0}),li.prototype.ngAfterViewChecked=function(){this._vc.emit()},li.prototype.ngAfterContentInit=function(){this._setCurrentForm(),this._init=!0},li.prototype.ngOnDestroy=function(){this._editConditionSub.unsubscribe(),this._beforeNodesUpdateSub.unsubscribe(),this._editChoicesOriginSub.unsubscribe(),this._stringIdentifierSub.unsubscribe(),this._service.setForm(null)},li.prototype.createChoicesOrigin=function(){this._service.createChoicesOrigin()},li.prototype.disableDropPredicate=function(){return!1},li.prototype.editChoicesOrigin=function(i){this._service.editChoicesOrigin(i)},li.prototype.editStringIdentifier=function(){null!=this._stringIdentifierDialog&&(this._stringIdentifierDialog.close(),this._stringIdentifierDialog=null),this._stringIdentifierDialog=this._dialog.open(ri,{disableClose:!0,width:"60%",height:"60%"})},li.prototype._setCurrentForm=function(){this._service.setForm(this._form)},li.decorators=[{type:o.Component,args:[{selector:"ajf-form-builder",template:'<mat-toolbar><button mat-icon-button (click)="leftSidenav.toggle()"><mat-icon>add_box</mat-icon></button> <button mat-button [matMenuTriggerFor]="choicesMenu" translate>Choices</button> <button mat-button (click)="editStringIdentifier()" translate>Identifier</button><mat-menu #choicesMenu><button (click)="createChoicesOrigin()" mat-menu-item translate>New..</button><ng-container *ngIf="choicesOrigins|async as cos"><button *ngFor="let choicesOrigin of cos" (click)="editChoicesOrigin(choicesOrigin)" mat-menu-item>{{ choicesOrigin.label || choicesOrigin.name }}</button></ng-container></mat-menu><span class="ajf-spacer"></span> <button mat-icon-button (click)="rightSidenav.toggle()"><mat-icon>settings</mat-icon></button></mat-toolbar><mat-drawer-container cdkDropListGroup><mat-drawer #leftSidenav position="start" mode="over"><div #sourceDropList cdkDropList [cdkDropListEnterPredicate]="disableDropPredicate" [cdkDropListData]="nodeTypes"><ajf-fb-node-type-entry *ngFor="let nodeType of nodeTypes" cdkDrag [cdkDragData]="nodeType" (cdkDragStarted)="leftSidenav.close()" [nodeType]="nodeType"></ajf-fb-node-type-entry></div></mat-drawer><mat-drawer #rightSidenav position="end" mode="side" [opened]="true"><ajf-fb-node-properties></ajf-fb-node-properties></mat-drawer><div #designer class="ajf-designer"><ajf-fb-node-entry *ngFor="let nodeEntry of (nodeEntriesTree|async); let isFirst = first" [isFirst]="isFirst" [nodeEntry]="nodeEntry"></ajf-fb-node-entry></div></mat-drawer-container>',styles:["ajf-form-builder mat-toolbar mat-menu div[mat-menu-item]>button[mat-button]{flex:1 0 auto}ajf-form-builder mat-toolbar mat-menu div[mat-menu-item]>button[mat-icon-button]{flex:0 0 auto}ajf-form-builder mat-drawer-container{height:700px}ajf-form-builder mat-drawer-container mat-drawer{max-width:20%}ajf-form-builder mat-drawer-container .ajf-designer{padding:1em;position:absolute;top:0;right:0;bottom:0;left:0;overflow-y:auto}ajf-form-builder mat-toolbar .ajf-spacer{flex:1 1 auto}"],changeDetection:o.ChangeDetectionStrategy.OnPush,encapsulation:o.ViewEncapsulation.None}]}],li.ctorParameters=function(){return[{type:K},{type:d.MatDialog}]},li.propDecorators={designerCont:[{type:o.ViewChild,args:["designer",{static:!0}]}],form:[{type:o.Input}]},li);function li(i,t){var e=this;this._service=i,this._dialog=t,this._vc=new o.EventEmitter,this._init=!1,this._editConditionSub=O.Subscription.EMPTY,this._beforeNodesUpdateSub=O.Subscription.EMPTY,this._editChoicesOriginSub=O.Subscription.EMPTY,this._stringIdentifierSub=O.Subscription.EMPTY,this._nodeTypes=i.availableNodeTypes,this._nodeEntriesTree=i.nodeEntriesTree,this._choicesOrigins=i.choicesOrigins,this._editConditionSub=this._service.editedCondition.subscribe(function(i){null!=e._editConditionDialog&&(e._editConditionDialog.close(),e._editConditionDialog=null),null!=i&&(e._editConditionDialog=e._dialog.open(ni,{disableClose:!0}))}),this._editChoicesOriginSub=this._service.editedChoicesOrigin.subscribe(function(i){null!=e._editChoicesOriginDialog&&(e._editChoicesOriginDialog.close(),e._editChoicesOriginDialog=null),null!=i&&(e._editChoicesOriginDialog=e._dialog.open(X,{disableClose:!0}))}),this._beforeNodesUpdateSub=this._service.beforeNodesUpdate.subscribe(function(){null!=e.designerCont&&(e._lastScrollTop=e.designerCont.nativeElement.scrollTop)}),this.nodeEntriesTree.pipe(D.sample(this._vc)).subscribe(function(){null!=e.designerCont&&(e.designerCont.nativeElement.scrollTop=e._lastScrollTop)}),this._stringIdentifierSub=this._service.stringIdentifier.subscribe(function(){})}var di=["#F44336","#4CAF50","#3F51B5","#FFC107","#795548"],ci=(Object.defineProperty(ui.prototype,"hasContent",{get:function(){return this._hasContent},enumerable:!0,configurable:!0}),Object.defineProperty(ui.prototype,"isFirst",{get:function(){return this._isFirst},set:function(i){this._isFirst=i},enumerable:!0,configurable:!0}),Object.defineProperty(ui.prototype,"isNodeEntry",{get:function(){return this._isNodeEntry},enumerable:!0,configurable:!0}),Object.defineProperty(ui.prototype,"nodeEntry",{get:function(){return this._nodeEntry},set:function(i){if(null!=(this._nodeEntry=i)&&void 0!==i.node){var t=i;this._isNodeEntry=!0;var e=t.node;this._hasContent=null!=e&&F.isContainerNode(e)}else this._isNodeEntry=!1,this._hasContent=!1},enumerable:!0,configurable:!0}),Object.defineProperty(ui.prototype,"level",{get:function(){return this._level},set:function(i){this._level=i},enumerable:!0,configurable:!0}),Object.defineProperty(ui.prototype,"realNodeEntry",{get:function(){return this._nodeEntry},enumerable:!0,configurable:!0}),Object.defineProperty(ui.prototype,"branchColors",{get:function(){return this._branchColors},enumerable:!0,configurable:!0}),Object.defineProperty(ui.prototype,"dropZones",{get:function(){return this._dropZones},enumerable:!0,configurable:!0}),Object.defineProperty(ui.prototype,"slideDropZones",{get:function(){return this._slideDropZones},enumerable:!0,configurable:!0}),Object.defineProperty(ui.prototype,"originOffset",{get:function(){return this._originOffset},set:function(i){this._originOffset=i,this._originLeftMargin=4*this._originOffset+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(ui.prototype,"originLeftMargin",{get:function(){return this._originLeftMargin},enumerable:!0,configurable:!0}),Object.defineProperty(ui.prototype,"firstBranchColor",{get:function(){return this._firstBranchColor},set:function(i){var t=di.indexOf(i);0<t?(this._firstBranchColor=i,this._branchColors=di.slice(t).concat(di.slice(0,t))):(this._firstBranchColor=di[0],this._branchColors=di.slice(0))},enumerable:!0,configurable:!0}),Object.defineProperty(ui.prototype,"currentEditedNode",{get:function(){return this._currentEditedNode},enumerable:!0,configurable:!0}),ui.prototype.onResize=function(){},ui.prototype.edit=function(){null!=this.nodeEntry&&this.isNodeEntry&&this._service.editNodeEntry(this.nodeEntry)},ui.prototype.delete=function(){null!=this.nodeEntry&&this.isNodeEntry&&this._service.deleteNodeEntry(this.nodeEntry)},ui.prototype.ngAfterViewInit=function(){var i=this;setTimeout(function(){return i._updateBranchHeights()}),this._childEntriesSubscription=this.childEntries.changes.subscribe(function(){i._updateBranchHeights()})},ui.prototype.ngOnDestroy=function(){this._branchLinesSubscription.unsubscribe(),this._childEntriesSubscription.unsubscribe()},ui.prototype.onDropSuccess=function(i,t){void 0===t&&(t=!1);var e=i.item.data;if(null!=this._nodeEntry){if(void 0!==e.nodeType&&(!this.isNodeEntry||this.isNodeEntry&&t)){var n=t?{parent:this.nodeEntry.node,parentNode:0}:this._nodeEntry;this._service.insertNode(e,n.parent,n.parentNode,t)}}else this._service.insertNode(e,null,0,t)},ui.prototype.disableSlideDropPredicate=function(i){return!i.data.isSlide},ui.prototype.emptyAreaDropPredicate=function(){var e=this;return function(i,t){return 0<e._level?!i.data.isSlide:i.data.isSlide||!1}},ui.prototype._updateBranchHeights=function(){if(null!=this.nodeEntry&&this.isNodeEntry&&null!=this.branchLines&&null!=this.childEntries){var i=this.nodeEntry,t=this.branchLines.toArray(),e=null!=i.content?i.content.length:0,n=this.childEntries.toArray().slice(e);t.length==n.length&&t.forEach(function(i,t){var e=n[t];i.height=e.nativeElement.offsetTop})}},ui.decorators=[{type:o.Component,args:[{selector:"ajf-fb-node-entry",template:'<ng-container *ngIf="nodeEntry != null ; else rootEmpty"><ng-template [ngIf]="isNodeEntry"><ajf-fb-branch-line *ngFor="let childNodeEntry of realNodeEntry.children; let idx = index" [offset]="idx" [color]="branchColors[idx]"></ajf-fb-branch-line></ng-template><div class="mat-card-container" [class.ajf-highlight]="(currentEditedNode|async) == nodeEntry"><div *ngIf="!isFirst" class="ajf-origin-line" [style.margin-left]="originLeftMargin" [style.border-color]="firstBranchColor"></div><ng-template [ngIf]="isNodeEntry"><mat-card><div class="ajf-title-row"><ajf-node-icon [node]="realNodeEntry.node"></ajf-node-icon><span class="ajf-title" [innerHTML]="(realNodeEntry.node.label || realNodeEntry.node.name)  | translate"></span> <span class="ajf-actions"><button [disabled]="currentEditedNode|async" (click)="edit()" mat-icon-button><mat-icon>edit</mat-icon></button> <button [disabled]="currentEditedNode|async" (click)="delete()" mat-icon-button><mat-icon>delete</mat-icon></button></span></div><div *ngIf="hasContent"><ajf-fb-node-entry *ngFor="let contentEntry of realNodeEntry.content; let isFirstChild = first; let idx = index" [level]="level + 1" [isFirst]="isFirstChild" [firstBranchColor]="branchColors[idx]" [nodeEntry]="contentEntry"></ajf-fb-node-entry><mat-card class="ajf-empty" *ngIf="realNodeEntry.content.length === 0" cdkDropList [cdkDropListEnterPredicate]="disableSlideDropPredicate" (cdkDropListDropped)="onDropSuccess($event, true)">&nbsp;</mat-card></div></mat-card></ng-template><ng-template [ngIf]="!isNodeEntry"><mat-card class="ajf-empty" cdkDropList [cdkDropListEnterPredicate]="emptyAreaDropPredicate()" (cdkDropListDropped)="onDropSuccess($event)">&nbsp;</mat-card></ng-template></div><ng-template [ngIf]="isNodeEntry"><ajf-fb-node-entry *ngFor="let childNodeEntry of realNodeEntry.children; let idx = index" [level]="level" [originOffset]="idx" [firstBranchColor]="branchColors[idx]" [nodeEntry]="childNodeEntry"></ajf-fb-node-entry></ng-template></ng-container><ng-template #rootEmpty><div class="mat-card-container"><mat-card class="ajf-empty" cdkDropList [cdkDropListEnterPredicate]="emptyAreaDropPredicate()" (cdkDropListDropped)="onDropSuccess($event)">&nbsp;</mat-card></div></ng-template>',styles:["ajf-fb-node-entry{display:block;position:relative}ajf-fb-node-entry .mat-card-container{position:relative}ajf-fb-node-entry .mat-card-container .ajf-origin-line{position:absolute;top:0;left:25px;width:25px;height:25px;border-bottom:2px solid;border-left:2px solid;border-bottom-left-radius:.5em}ajf-fb-node-entry .mat-card-container mat-card{margin-left:50px;padding:.5em 1em;margin-top:.2em;margin-bottom:.2em;background-color:#fff}ajf-fb-node-entry .mat-card-container mat-card .ajf-title-row{display:flex;flex-direction:row;align-items:center}ajf-fb-node-entry .mat-card-container mat-card .ajf-title-row>.ajf-title{flex:1 1 auto}ajf-fb-node-entry .mat-card-container mat-card .ajf-title-row>.ajf-actions{flex:0 0 auto;white-space:nowrap}ajf-fb-node-entry .mat-card-container mat-card.ajf-empty{line-height:36px;border:2px dashed;box-shadow:none;box-sizing:border-box}ajf-fb-node-entry .mat-card-container.ajf-highlight>mat-card{background-color:#fff9c4}"],host:{"(window.resize)":"onResize()"},encapsulation:o.ViewEncapsulation.None,changeDetection:o.ChangeDetectionStrategy.OnPush}]}],ui.ctorParameters=function(){return[{type:K}]},ui.propDecorators={branchLines:[{type:o.ViewChildren,args:[P]}],childEntries:[{type:o.ViewChildren,args:[ui,{read:o.ElementRef}]}],isFirst:[{type:o.Input}],nodeEntry:[{type:o.Input}],level:[{type:o.Input}],originOffset:[{type:o.Input}],firstBranchColor:[{type:o.Input}]},ui);function ui(i){this._service=i,this._hasContent=!1,this._isFirst=!1,this._isNodeEntry=!1,this._level=0,this._branchColors=di.slice(0),this._dropZones=["fbdz-node"],this._slideDropZones=["fbdz-slide"],this._originOffset=0,this._originLeftMargin="0",this._firstBranchColor=di[0],this._branchLinesSubscription=O.Subscription.EMPTY,this._childEntriesSubscription=O.Subscription.EMPTY,this._currentEditedNode=this._service.editedNodeEntry}var pi=(Object.defineProperty(fi.prototype,"fields",{get:function(){return this._fields},enumerable:!0,configurable:!0}),fi.prototype.saveCondition=function(){if(null!=this.editor){var i=this.editor.editedValue;this.dialogRef.close({condition:i,errorMessage:this.errorMessage})}},fi.decorators=[{type:o.Component,args:[{selector:"ajf-fb-validation-condition-editor-dialog",template:'<h3 matDialogTitle translate>Edit condition</h3><mat-dialog-content><mat-form-field><input matInput [(ngModel)]="errorMessage" [placeholder]="\'Error message\' | translate"></mat-form-field><ajf-condition-editor [fields]="fields|async" [condition]="condition"></ajf-condition-editor></mat-dialog-content><mat-dialog-actions><button mat-button translate (click)="saveCondition()">Save</button> <button mat-button translate matDialogClose>Close</button></mat-dialog-actions>',styles:["ajf-fb-validation-condition-editor-dialog mat-dialog-content{overflow:visible}"],encapsulation:o.ViewEncapsulation.None,changeDetection:o.ChangeDetectionStrategy.OnPush}]}],fi.ctorParameters=function(){return[{type:K},{type:d.MatDialogRef}]},fi.propDecorators={editor:[{type:o.ViewChild,args:[ti,{static:!0}]}]},fi);function fi(i,t){this.dialogRef=t,this._fields=i.flatFields.pipe(D.map(function(i){return i.sort(function(i,t){return i.name.localeCompare(t.name)})}))}var hi=(Object.defineProperty(mi.prototype,"fields",{get:function(){return this._fields},enumerable:!0,configurable:!0}),mi.prototype.saveCondition=function(){if(null!=this.editor){var i=this.editor.editedValue;this.dialogRef.close({condition:i,warningMessage:this.warningMessage})}},mi.decorators=[{type:o.Component,args:[{selector:"ajf-fb-warning-condition-editor-dialog",template:'<h3 matDialogTitle translate>Edit condition</h3><mat-dialog-content><mat-form-field><input matInput [(ngModel)]="warningMessage" [placeholder]="\'Warning message\' | translate"></mat-form-field><ajf-condition-editor [fields]="fields|async" [condition]="condition"></ajf-condition-editor></mat-dialog-content><mat-dialog-actions><button mat-button translate (click)="saveCondition()">Save</button> <button mat-button translate matDialogClose>Close</button></mat-dialog-actions>',styles:["ajf-fb-warning-condition-editor-dialog mat-dialog-content{overflow:visible}"],encapsulation:o.ViewEncapsulation.None,changeDetection:o.ChangeDetectionStrategy.OnPush}]}],mi.ctorParameters=function(){return[{type:K},{type:d.MatDialogRef}]},mi.propDecorators={editor:[{type:o.ViewChild,args:[ti,{static:!0}]}]},mi);function mi(i,t){this.dialogRef=t,this._fields=i.flatFields.pipe(D.map(function(i){return i.sort(function(i,t){return i.name.localeCompare(t.name)})}))}function gi(i){var t=i.value.minReps,e=i.value.maxReps;return null!=t&&null!=e&&e<t?{reps:"Min repetions cannot be greater than max repetitions"}:null}function bi(i){var t=i.value.minValue,e=i.value.maxValue;return null!=t&&null!=e&&e<t?{valueLimit:"Min value cannot be greater than max value"}:null}function vi(i){var t=i.value.minDigits,e=i.value.maxDigits;return null!=t&&null!=e&&e<t?{digits:"Min digits cannot be greater than max digits"}:null}var _i=(Object.defineProperty(yi.prototype,"fieldSizes",{get:function(){return this._fieldSizes},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"nodeEntry",{get:function(){return this._nodeEntry},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"choicesOrigins",{get:function(){return this._choicesOrigins},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"enabled",{get:function(){return this._enabled},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"propertiesForm",{get:function(){return this._propertiesForm},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"hasChoices",{get:function(){return this._hasChoices},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"curVisibility",{get:function(){return this._curVisibility},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"curFormulaReps",{get:function(){return this._curFormulaReps},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"curChoicesFilter",{get:function(){return this._curChoicesFilter},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"curForceValue",{get:function(){return this._curForceValue},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"curFormula",{get:function(){return this._curFormula},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"conditionalBranches",{get:function(){return this._conditionalBranches},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"validationConditions",{get:function(){return this._validationConditions},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"warningConditions",{get:function(){return this._warningConditions},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"nextSlideCondition",{get:function(){return this._nextSlideCondition},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"triggerConditions",{get:function(){return this._triggerConditions},enumerable:!0,configurable:!0}),yi.prototype.editVisibility=function(){this._editVisibilityEvt.emit()},yi.prototype.editConditionalBranch=function(i){i<0||i>=this._conditionalBranches.length||this._editConditionalBranchEvt.emit(i)},yi.prototype.editFormulaReps=function(){this._editFormulaRepsEvt.emit()},yi.prototype.editChoicesFilter=function(){this._editChoicesFilterEvt.emit()},yi.prototype.editFormula=function(){this._editFormulaEvt.emit()},yi.prototype.editForceValue=function(){this._editForceValueEvt.emit()},yi.prototype.editValidationCondition=function(i){i<0||i>=this._validationConditions.length||this._editValidationConditionEvt.emit(i)},yi.prototype.addValidationCondition=function(){this._addValidationConditionEvt.emit()},yi.prototype.removeValidationCondition=function(i){i<0||i>=this._validationConditions.length||this._removeValidationConditionEvt.emit(i)},yi.prototype.editWarningCondition=function(i){i<0||i>=this._warningConditions.length||this._editWarningConditionEvt.emit(i)},yi.prototype.addWarningCondition=function(){this._addWarningConditionEvt.emit()},yi.prototype.removeWarningCondition=function(i){i<0||i>=this._warningConditions.length||this._removeWarningConditionEvt.emit(i)},yi.prototype.editNextSlideCondition=function(){this._editNextSlideConditionEvt.emit()},yi.prototype.editTriggerCondition=function(i){i<0||i>=this._triggerConditions.length||this._editTriggerConditionEvt.emit(i)},yi.prototype.addTriggerCondition=function(){this._addTriggerConditionEvt.emit()},yi.prototype.removeTriggerCondition=function(i){i<0||i>=this._triggerConditions.length||this._removeTriggerConditionEvt.emit(i)},yi.prototype.isField=function(i){return F.isField(i)},yi.prototype.isNumericField=function(i){return F.isField(i)&&F.isNumberField(i)},yi.prototype.isFieldWithChoices=function(i){return F.isField(i)&&F.isFieldWithChoices(i)},yi.prototype.save=function(){this._saveEvt.emit()},yi.prototype.cancel=function(){this._service.cancelNodeEntryEdit()},yi.prototype.ngOnDestroy=function(){this._choicesOriginsSub.unsubscribe(),this._visibilitySub.unsubscribe(),this._formulaRepsSub.unsubscribe(),this._choicesFilterSub.unsubscribe(),this._formulaSub.unsubscribe(),this._forceValueSub.unsubscribe(),this._validationConditionsSub.unsubscribe(),this._warningConditionsSub.unsubscribe(),this._triggerConditionsSub.unsubscribe(),this._editConditionDialogSub.unsubscribe(),this._editValidationConditionDialogSub.unsubscribe(),this._editWarningConditionDialogSub.unsubscribe(),this._editChoicesFilterSub.unsubscribe(),this._editConditionalBranchSub.unsubscribe(),this._editVisibilitySub.unsubscribe(),this._editFormulaRepsSub.unsubscribe(),this._editFormulaSub.unsubscribe(),this._editForceValueSub.unsubscribe(),this._editValidationConditionSub.unsubscribe(),this._editWarningConditionSub.unsubscribe(),this._nextSlideConditionSub.unsubscribe(),this._addTriggerConditionSub.unsubscribe(),this._addValidationConditionSub.unsubscribe(),this._addWarningConditionSub.unsubscribe(),this._editNextSlideConditionSub.unsubscribe(),this._editTriggerConditionSub.unsubscribe(),this._removeTriggerConditionSub.unsubscribe(),this._removeValidationConditionSub.unsubscribe(),this._removeWarningConditionSub.unsubscribe(),this._saveSub.unsubscribe()},yi.prototype._initSave=function(){var n=this;this._saveSub=this._saveEvt.pipe(D.withLatestFrom(this.propertiesForm)).subscribe(function(i){var t=i[1],e=M({},t.value,{conditionalBranches:n._conditionalBranches});n._service.saveNodeEntry(e)})},yi.prototype._initForm=function(){var S=this;this._propertiesForm=this._nodeEntry.pipe(D.filter(function(i){return null!=i}),D.map(function(i){null!=S._visibilitySub&&S._visibilitySub.unsubscribe(),null!=S._conditionalBranchesSub&&S._conditionalBranchesSub.unsubscribe();var t=null!=(i=i).node.visibility?i.node.visibility.condition:null,e=null!=i.node.visibility?S._guessVisibilityOpt(i.node.visibility):null,n={name:[i.node.name,j.Validators.required],label:i.node.label,visibilityOpt:[e,j.Validators.required],visibility:[t,j.Validators.required],conditionalBranchesNum:i.node.conditionalBranches.length},o=[];if(F.isRepeatingContainerNode(i.node)){var r=i.node,a=null!=r.formulaReps?r.formulaReps.formula:null;n.formulaReps=[a,j.Validators.required],n.minReps=r.minReps,n.maxReps=r.maxReps,S._curFormulaReps=a,o.push(gi)}if(S.isField(i.node)){var s=i.node,l=null,d=!1,c=[];null!=s.validation&&(null!=s.validation.forceValue&&(l=s.validation.forceValue.condition),d=null!=s.validation.notEmpty,c=(s.validation.conditions||[]).map(function(i){return{condition:i.condition,errorMessage:i.errorMessage}}));var u=!1,p=[];null!=s.warning&&(u=null!=s.warning.notEmpty,p=(s.warning.conditions||[]).map(function(i){return{condition:i.condition,warningMessage:i.warningMessage}}));var f=null!=s.formula?s.formula.formula:null;n.description=s.description,n.defaultValue=s.defaultValue,n.size=s.size,n.formula=f,n.forceValue=l,n.notEmpty=d,n.validationConditions=[c,[]],n.notEmptyWarning=u,n.warningConditions=[p,[]],n.nextSlideCondition=[s.nextSlideCondition],S._curForceValue=l,S._curFormula=f,S._validationConditions=c,S._warningConditions=p}if(S.isNumericField(i.node)){var h=i.node,m=void 0,g=void 0,b=void 0,v=void 0;null!=h.validation&&(null!=h.validation.minValue&&(m=(h.validation.minValue.condition||"").replace("$value >= ","")),null!=h.validation.maxValue&&(g=(h.validation.maxValue.condition||"").replace("$value <= ","")),null!=h.validation.minDigits&&(b=(h.validation.minDigits.condition||"").replace("$value.toString().length >= ","")),null!=h.validation.maxDigits&&(v=(h.validation.maxDigits.condition||"").replace("$value.toString().length <= ",""))),n.minValue=m,n.maxValue=g,n.minDigits=b,n.maxDigits=v,o.push(bi),o.push(vi)}if(S.isFieldWithChoices(i.node)){var _=i.node,y=(_.triggerConditions||[]).map(function(i){return i.condition});n.choicesOriginRef=_.choicesOriginRef,n.choicesFilter=null!=_.choicesFilter?_.choicesFilter.formula:null,n.forceExpanded=_.forceExpanded,n.forceNarrow=_.forceNarrow,n.triggerConditions=y,S._triggerConditions=y}var C=S._fb.group(n);return C.setValidators(o),S._conditionalBranches=i.node.conditionalBranches.map(function(i){return i.condition}),S._curVisibility=null!=i.node.visibility?i.node.visibility.condition:null,S._handleConditionalBranchesChange(C),S._handleVisibilityChange(C),S._handleFormulaRepsChange(C),S._handleChoicesFilterChange(C),S._handleFormulaChange(C),S._handleForceValueChange(C),S._handleValidationCondtionsChange(C),S._handleWarningCondtionsChange(C),S._handleNextSlideConditionChange(C),S._handleTriggerCondtionsChange(C),C}),D.publishReplay(1),D.refCount())},yi.prototype._destroyConditionDialog=function(){null!=this._editConditionDialogSub&&(this._editConditionDialogSub.unsubscribe(),this._editConditionDialogSub=O.Subscription.EMPTY),null!=this._editConditionDialog&&(this._editConditionDialog.close(),this._editConditionDialog=null)},yi.prototype._destroyValidationConditionDialog=function(){null!=this._editValidationConditionDialogSub&&(this._editValidationConditionDialogSub.unsubscribe(),this._editValidationConditionDialogSub=O.Subscription.EMPTY),null!=this._editValidationConditionDialog&&(this._editValidationConditionDialog.close(),this._editValidationConditionDialog=null)},yi.prototype._destroyWarningConditionDialog=function(){null!=this._editWarningConditionDialogSub&&(this._editWarningConditionDialogSub.unsubscribe(),this._editWarningConditionDialogSub=O.Subscription.EMPTY),null!=this._editWarningConditionDialog&&(this._editWarningConditionDialog.close(),this._editWarningConditionDialog=null)},yi.prototype._initRemoveTriggerCondition=function(){this._removeTriggerConditionSub=this._removeTriggerConditionEvt.pipe(D.withLatestFrom(this._propertiesForm)).subscribe(function(i){var t=i[0],e=i[1];if(null!=e){var n=e.controls.triggerConditions,o=(n.value||[]).slice(0);t<0||t>=o.length||(o.splice(t,1),n.setValue(o))}})},yi.prototype._initAddTriggerCondition=function(){this._addTriggerConditionSub=this._addTriggerConditionEvt.pipe(D.withLatestFrom(this._propertiesForm)).subscribe(function(i){var t=i[1];if(null!=t){var e=t.controls.triggerConditions,n=(e.value||[]).slice(0);n.push(""),e.setValue(n)}})},yi.prototype._initTriggerConditionEdit=function(){var n=this;this._editTriggerConditionSub=this._editTriggerConditionEvt.pipe(D.withLatestFrom(this._propertiesForm)).subscribe(function(i){n._destroyConditionDialog();var t=i[0],e=i[1];t<0||t>=n._triggerConditions.length||null==e||(n._editConditionDialog=n._dialog.open(ni),n._editConditionDialog.componentInstance.condition=n._triggerConditions[t],n._editConditionDialogSub=n._editConditionDialog.afterClosed().subscribe(function(i){void 0!==i&&(n._triggerConditions[t]=i),n._editConditionDialogSub.unsubscribe(),n._editConditionDialogSub=O.Subscription.EMPTY}))})},yi.prototype._initRemoveWarningCondition=function(){this._removeWarningConditionSub=this._removeWarningConditionEvt.pipe(D.withLatestFrom(this._propertiesForm)).subscribe(function(i){var t=i[0],e=i[1];if(null!=e){var n=e.controls.warningConditions,o=(n.value||[]).slice(0);t<0||t>=o.length||(o.splice(t,1),n.setValue(o))}})},yi.prototype._initAddWarningCondition=function(){this._addWarningConditionSub=this._addWarningConditionEvt.pipe(D.withLatestFrom(this._propertiesForm)).subscribe(function(i){var t=i[1];if(null!=t){var e=t.controls.warningConditions,n=(e.value||[]).slice(0);n.push({condition:"",errorMessage:""}),e.setValue(n)}})},yi.prototype._initWarningConditionEdit=function(){var r=this;this._editWarningConditionSub=this._editWarningConditionEvt.pipe(D.withLatestFrom(this._propertiesForm)).subscribe(function(i){r._destroyWarningConditionDialog();var t=i[0],e=i[1];if(!(t<0||t>=r._warningConditions.length||null==e)){r._editWarningConditionDialog=r._dialog.open(hi);var n=r._editWarningConditionDialog.componentInstance,o=r._warningConditions[t];n.condition=o.condition,n.warningMessage=o.warningMessage,r._editWarningConditionDialogSub=r._editWarningConditionDialog.afterClosed().subscribe(function(i){void 0!==i&&(r._warningConditions[t]=i),r._editWarningConditionDialogSub.unsubscribe(),r._editWarningConditionDialogSub=O.Subscription.EMPTY})}})},yi.prototype._initRemoveValidationCondition=function(){this._removeValidationConditionSub=this._removeValidationConditionEvt.pipe(D.withLatestFrom(this._propertiesForm)).subscribe(function(i){var t=i[0],e=i[1];if(null!=e){var n=e.controls.validationConditions,o=(n.value||[]).slice(0);t<0||t>=o.length||(o.splice(t,1),n.setValue(o))}})},yi.prototype._initAddValidationCondition=function(){this._addValidationConditionSub=this._addValidationConditionEvt.pipe(D.withLatestFrom(this._propertiesForm)).subscribe(function(i){var t=i[1];if(null!=t){var e=t.controls.validationConditions,n=(e.value||[]).slice(0);n.push({condition:"",errorMessage:""}),e.setValue(n)}})},yi.prototype._initValidationConditionEdit=function(){var r=this;this._editValidationConditionSub=this._editValidationConditionEvt.pipe(D.withLatestFrom(this._propertiesForm)).subscribe(function(i){r._destroyValidationConditionDialog();var t=i[0],e=i[1];if(!(t<0||t>=r._validationConditions.length||null==e)){r._editValidationConditionDialog=r._dialog.open(pi);var n=r._editValidationConditionDialog.componentInstance,o=r._validationConditions[t];n.condition=o.condition,n.errorMessage=o.errorMessage,r._editValidationConditionDialogSub=r._editValidationConditionDialog.afterClosed().subscribe(function(i){void 0!==i&&(r._validationConditions[t]=i),r._editValidationConditionDialogSub.unsubscribe(),r._editValidationConditionDialogSub=O.Subscription.EMPTY})}})},yi.prototype._initForceValueEdit=function(){var n=this;this._editForceValueSub=this._editForceValueEvt.pipe(D.withLatestFrom(this._propertiesForm)).subscribe(function(i){n._destroyConditionDialog();var t=i[1];if(null!=t){var e=t.controls.forceValue;n._editConditionDialog=n._dialog.open(ni),n._editConditionDialog.componentInstance.condition=e.value,n._editConditionDialogSub=n._editConditionDialog.afterClosed().subscribe(function(i){void 0!==i&&e.setValue(i),n._editConditionDialogSub.unsubscribe(),n._editConditionDialogSub=O.Subscription.EMPTY})}})},yi.prototype._initNextSlideConditionEdit=function(){var n=this;this._editNextSlideConditionSub=this._editNextSlideConditionEvt.pipe(D.withLatestFrom(this._propertiesForm)).subscribe(function(i){n._destroyConditionDialog();var t=i[1];if(null!=t){var e=t.controls.nextSlideCondition;n._editConditionDialog=n._dialog.open(ni),n._editConditionDialog.componentInstance.condition=e.value,n._editConditionDialogSub=n._editConditionDialog.afterClosed().subscribe(function(i){void 0!==i&&e.setValue(i),n._editConditionDialogSub.unsubscribe(),n._editConditionDialogSub=O.Subscription.EMPTY})}})},yi.prototype._initFormulaEdit=function(){var n=this;this._editFormulaSub=this._editFormulaEvt.pipe(D.withLatestFrom(this._propertiesForm)).subscribe(function(i){n._destroyConditionDialog();var t=i[1];if(null!=t){var e=t.controls.formula;n._editConditionDialog=n._dialog.open(ni),n._editConditionDialog.componentInstance.condition=e.value,n._editConditionDialogSub=n._editConditionDialog.afterClosed().subscribe(function(i){void 0!==i&&e.setValue(i),n._editConditionDialogSub.unsubscribe(),n._editConditionDialogSub=O.Subscription.EMPTY})}})},yi.prototype._initFormulaRepsEdit=function(){var n=this;this._editFormulaRepsSub=this._editFormulaRepsEvt.pipe(D.withLatestFrom(this._propertiesForm)).subscribe(function(i){n._destroyConditionDialog();var t=i[1];if(null!=t){var e=t.controls.formulaReps;n._editConditionDialog=n._dialog.open(ni),n._editConditionDialog.componentInstance.condition=e.value,n._editConditionDialogSub=n._editConditionDialog.afterClosed().subscribe(function(i){void 0!==i&&e.setValue(i),n._editConditionDialogSub.unsubscribe(),n._editConditionDialogSub=O.Subscription.EMPTY})}})},yi.prototype._initChoicesFilterEdit=function(){var n=this;this._editChoicesFilterSub=this._editChoicesFilterEvt.pipe(D.withLatestFrom(this._propertiesForm)).subscribe(function(i){n._destroyConditionDialog();var t=i[1];if(null!=t){var e=t.controls.choicesFilter;n._editConditionDialog=n._dialog.open(ni),n._editConditionDialog.componentInstance.condition=e.value,n._editConditionDialogSub=n._editConditionDialog.afterClosed().subscribe(function(i){void 0!==i&&e.setValue(i),n._editConditionDialogSub.unsubscribe(),n._editConditionDialogSub=O.Subscription.EMPTY})}})},yi.prototype._initConditionalBranchEdit=function(){var n=this;this._editConditionalBranchSub=this._editConditionalBranchEvt.pipe(D.withLatestFrom(this._propertiesForm)).subscribe(function(i){n._destroyConditionDialog();var t=i[0],e=i[1];t<0||t>=n._conditionalBranches.length||null==e||(n._editConditionDialog=n._dialog.open(ni),n._editConditionDialog.componentInstance.condition=n._conditionalBranches[t],n._editConditionDialogSub=n._editConditionDialog.afterClosed().subscribe(function(i){void 0!==i&&(n._conditionalBranches[t]=i),n._editConditionDialogSub.unsubscribe(),n._editConditionDialogSub=O.Subscription.EMPTY}))})},yi.prototype._initVisibilityEdit=function(){var o=this;this._editVisibilitySub=this._editVisibilityEvt.pipe(D.withLatestFrom(this._propertiesForm)).subscribe(function(i){o._destroyConditionDialog();var t=i[1];if(null!=t){var e=t.controls.visibility,n=e.value;o._editConditionDialog=o._dialog.open(ni),o._editConditionDialog.componentInstance.condition=n,o._editConditionDialogSub=o._editConditionDialog.afterClosed().subscribe(function(i){void 0!==i&&e.setValue(i),o._editConditionDialogSub.unsubscribe(),o._editConditionDialogSub=O.Subscription.EMPTY})}})},yi.prototype._handleTriggerCondtionsChange=function(i){var t=this;this._triggerConditionsSub=i.valueChanges.pipe(D.distinctUntilChanged(function(i,t){return JSON.stringify(i.triggerConditions)===JSON.stringify(t.triggerConditions)})).subscribe(function(i){t._triggerConditions=i.triggerConditions})},yi.prototype._handleWarningCondtionsChange=function(i){var t=this;this._warningConditionsSub=i.valueChanges.pipe(D.distinctUntilChanged(function(i,t){return JSON.stringify(i.warningConditions)===JSON.stringify(t.warningConditions)})).subscribe(function(i){t._warningConditions=i.warningConditions})},yi.prototype._handleValidationCondtionsChange=function(i){var t=this;this._validationConditionsSub=i.valueChanges.pipe(D.distinctUntilChanged(function(i,t){return JSON.stringify(i.validationConditions)===JSON.stringify(t.validationConditions)})).subscribe(function(i){t._validationConditions=i.validationConditions})},yi.prototype._handleForceValueChange=function(i){var t=this;this._forceValueSub=i.valueChanges.pipe(D.distinctUntilChanged(function(i,t){return i.forceValue===t.forceValue})).subscribe(function(i){t._curForceValue=i.forceValue})},yi.prototype._handleNextSlideConditionChange=function(i){var t=this;this._formulaSub=i.valueChanges.pipe(D.distinctUntilChanged(function(i,t){return i.nextSlideCondition===t.nextSlideCondition})).subscribe(function(i){t._nextSlideCondition=i.nextSlideCondition})},yi.prototype._handleFormulaChange=function(i){var t=this;this._formulaSub=i.valueChanges.pipe(D.distinctUntilChanged(function(i,t){return i.formula===t.formula})).subscribe(function(i){t._curFormula=i.formula})},yi.prototype._handleFormulaRepsChange=function(i){var t=this;this._formulaRepsSub=i.valueChanges.pipe(D.distinctUntilChanged(function(i,t){return i.formulaReps===t.formulaReps})).subscribe(function(i){t._curFormulaReps=i.formulaReps})},yi.prototype._handleChoicesFilterChange=function(i){var t=this;this._choicesFilterSub=i.valueChanges.pipe(D.distinctUntilChanged(function(i,t){return i.choicesFilter===t.choicesFilter})).subscribe(function(i){t._curChoicesFilter=i.choicesFilter})},yi.prototype._handleConditionalBranchesChange=function(i){var r=this;this._conditionalBranchesSub=i.valueChanges.pipe(D.distinctUntilChanged(function(i,t){return i.conditionalBranchesNum===t.conditionalBranchesNum})).subscribe(function(i){var t=i.conditionalBranchesNum,e=r._conditionalBranches.length;if(e<t){for(var n=[],o=e;o<t;o++)n.push(w.alwaysCondition().condition);r._conditionalBranches=r._conditionalBranches.concat(n)}else t<e&&r._conditionalBranches.splice(0,e-t)})},yi.prototype._handleVisibilityChange=function(e){var n=this;this._visibilitySub=e.valueChanges.pipe(D.distinctUntilChanged(function(i,t){return i.visibilityOpt===t.visibilityOpt})).subscribe(function(i){var t;switch(i.visibilityOpt){case"always":t=w.alwaysCondition().condition;break;case"never":t=w.neverCondition().condition;break;default:t=null}n._curVisibility=t,e.controls.visibility.setValue(t)})},yi.prototype._guessVisibilityOpt=function(i){return 0===i.condition.localeCompare(w.alwaysCondition().condition)?"always":0===i.condition.localeCompare(w.neverCondition().condition)?"never":"condition"},yi.decorators=[{type:o.Component,args:[{selector:"ajf-fb-node-properties",template:'<div [style.display]="(enabled|async) ? \'none\' : \'block\'" class="ajf-disabled-overlay"></div><div class="ajf-header"><h3 translate>Properties</h3><mat-icon (click)="save()">save</mat-icon><mat-icon (click)="cancel()">cancel</mat-icon></div><ng-container *ngIf="nodeEntry|async as ne"><ng-container *ngIf="propertiesForm|async as pf"><form [formGroup]="pf" novalidate><div class="ajf-prop"><mat-form-field><input matInput formControlName="name" [placeholder]="\'Name\' | translate"></mat-form-field></div><div class="ajf-prop"><mat-form-field><input matInput formControlName="label" [placeholder]="\'Label\' | translate"></mat-form-field></div><div class="ajf-prop"><mat-form-field><mat-label translate>Visibility</mat-label><mat-select formControlName="visibilityOpt" [placeholder]="\'Visible\' | translate"><mat-option value="always" translate>Always</mat-option><mat-option value="never" translate>Never</mat-option><mat-option value="condition" translate>Condition...</mat-option></mat-select></mat-form-field><button (click)="editVisibility()" [disabled]="pf.value[\'visibilityOpt\'] != \'condition\'" mat-raised-button [matTooltip]="curVisibility"><div class="ajf-icon-cont"><mat-icon>edit</mat-icon><span>{{ curVisibility }}</span></div></button></div><div class="ajf-prop"><div><label translate>Branches</label></div><div><mat-slider formControlName="conditionalBranchesNum" thumbLabel tickInterval="auto" min="1" max="5" step="1"></mat-slider></div><div *ngFor="let branch of conditionalBranches; let idx = index"><button (click)="editConditionalBranch(idx)" mat-raised-button [matTooltip]="branch"><div class="ajf-icon-cont"><mat-icon>edit</mat-icon><span>{{ branch }}</span></div></button></div></div><ng-template [ngIf]="isRepeatingContainerNode((ne)?.node)"><div class="ajf-prop"><div><label translate>Repetitions</label></div><div><button (click)="editFormulaReps()" mat-raised-button [matTooltip]="curFormulaReps"><div class="ajf-icon-cont"><mat-icon>edit</mat-icon><span>{{ curFormulaReps }}</span></div></button></div><div><label translate>Min repetitions</label></div><div><mat-slider formControlName="minReps" thumbLabel tickInterval="auto" min="1" max="5" step="1"></mat-slider></div><div><label translate>Max repetitions</label></div><div><mat-slider formControlName="maxReps" thumbLabel tickInterval="auto" min="1" max="5" step="1"></mat-slider></div></div></ng-template><ng-template [ngIf]="isField((ne)?.node)"><div class="ajf-prop"><mat-form-field><mat-label translate>Field size</mat-label><mat-select formControlName="size" [placeholder]="\'Size\' | translate"><mat-option *ngFor="let fieldSize of fieldSizes" [value]="fieldSize.value">{{ fieldSize.label }}</mat-option></mat-select></mat-form-field></div><div class="ajf-prop"><mat-form-field><textarea matInput formControlName="description" [placeholder]="\'Description\' | translate"></textarea></mat-form-field></div><div class="ajf-prop"><mat-form-field><input matInput formControlName="defaultValue" [placeholder]="\'Default value\' | translate"></mat-form-field></div><div class="ajf-prop"><div><label translate>Formula</label></div><div><button (click)="editFormula()" mat-raised-button [matTooltip]="curFormula"><div class="ajf-icon-cont"><mat-icon>edit</mat-icon><span>{{ curFormula }}</span></div></button></div></div><div class="ajf-prop"><mat-checkbox formControlName="notEmpty" translate>Not empty</mat-checkbox></div><ng-template [ngIf]="isNumericField((ne)?.node)"><div class="ajf-prop"><mat-form-field><input matInput formControlName="minValue" [placeholder]="\'Min value\' | translate"></mat-form-field></div><div class="ajf-prop"><mat-form-field><input matInput formControlName="maxValue" [placeholder]="\'Max value\' | translate"></mat-form-field></div><div class="ajf-prop"><mat-form-field><input matInput formControlName="minDigits" [placeholder]="\'Min digits\' | translate"></mat-form-field></div><div class="ajf-prop"><mat-form-field><input matInput formControlName="maxDigits" [placeholder]="\'Max digits\' | translate"></mat-form-field></div></ng-template><div class="ajf-prop"><div class="ajf-header"><label translate>Validation</label><mat-icon class="ajf-pointer" (click)="addValidationCondition()">add_circle_outline</mat-icon></div><div *ngIf="validationConditions == null || validationConditions.length == 0" class="ajf-validation-row ajf-emph" translate>No conditions</div><div class="ajf-validation-row" *ngFor="let validationCondition of validationConditions; let idx = index"><button (click)="editValidationCondition(idx)" mat-raised-button [matTooltip]="validationCondition.condition"><div class="ajf-icon-cont"><mat-icon>edit</mat-icon><span>{{ validationCondition.condition }}</span></div></button><mat-icon class="ajf-pointer" (click)="removeValidationCondition(idx)">remove_circle_outline</mat-icon></div></div><div class="ajf-prop"><mat-checkbox formControlName="notEmptyWarning" translate>Not empty warning</mat-checkbox></div><div class="ajf-prop"><div class="ajf-header"><label translate>Warnings</label><mat-icon class="ajf-pointer" (click)="addWarningCondition()">add_circle_outline</mat-icon></div><div *ngIf="warningConditions == null || warningConditions.length == 0" class="ajf-validation-row ajf-emph" translate>No warnings</div><div class="ajf-validation-row" *ngFor="let warningCondition of warningConditions; let idx = index"><button (click)="editWarningCondition(idx)" mat-raised-button [matTooltip]="warningCondition.condition"><div class="ajf-icon-cont"><mat-icon>edit</mat-icon><span>{{ warningCondition.condition }}</span></div></button><mat-icon class="ajf-pointer" (click)="removeWarningCondition(idx)">remove_circle_outline</mat-icon></div></div><div class="ajf-prop"><div><label translate>Go to next slide condition</label></div><div><button (click)="editNextSlideCondition()" mat-raised-button [matTooltip]="nextSlideCondition"><div class="ajf-icon-cont"><mat-icon>edit</mat-icon><span>{{ nextSlideCondition }}</span></div></button></div></div><ng-template [ngIf]="isFieldWithChoices((ne)?.node)"><div class="ajf-prop"><mat-form-field><mat-label translate>Choices origins</mat-label><mat-select formControlName="choicesOriginRef" [placeholder]="\'Choices\' | translate"><mat-option *ngFor="let choicesOrigin of choicesOrigins" [value]="choicesOrigin.name">{{ choicesOrigin.label || choicesOrigin.name }}</mat-option></mat-select></mat-form-field></div><div class="ajf-prop"><div><label translate>Choices filter</label></div><div><button (click)="editChoicesFilter()" mat-raised-button [matTooltip]="curChoicesFilter"><div class="ajf-icon-cont"><mat-icon>edit</mat-icon><span>{{ curChoicesFilter }}</span></div></button></div></div><div class="ajf-prop"><mat-checkbox formControlName="forceExpanded" translate>Force expanded selection</mat-checkbox></div><div class="ajf-prop"><mat-checkbox formControlName="forceNarrow" translate>Force narrow selection</mat-checkbox></div><div class="ajf-prop"><div class="ajf-header"><label translate>Trigger selection</label><mat-icon class="ajf-pointer" (click)="addTriggerCondition()">add_circle_outline</mat-icon></div><div *ngIf="triggerConditions == null || triggerConditions.length == 0" class="ajf-validation-row ajf-emph" translate>No trigger condition</div><div class="ajf-validation-row" *ngFor="let triggerCondition of triggerConditions; let idx = index"><button (click)="editTriggerCondition(idx)" mat-raised-button [matTooltip]="triggerCondition"><div class="ajf-icon-cont"><mat-icon>edit</mat-icon><span>{{ triggerCondition }}</span></div></button><mat-icon class="pointer" (click)="removeTriggerCondition(idx)">remove_circle_outline</mat-icon></div></div></ng-template></ng-template></form></ng-container></ng-container>',styles:["ajf-fb-node-properties{display:block;padding:1em;position:relative}ajf-fb-node-properties mat-icon{cursor:pointer}ajf-fb-node-properties .ajf-header{display:flex;flex-direction:row;align-items:center;flex-wrap:nowrap}ajf-fb-node-properties .ajf-header>h3,ajf-fb-node-properties .ajf-header>label{flex:1 0 auto;margin-right:.5em}ajf-fb-node-properties .ajf-header>mat-icon{flex:0 0 auto;margin-left:.5em}ajf-fb-node-properties .ajf-disabled-overlay{position:absolute;top:0;right:0;bottom:0;left:0;opacity:.4;background-color:#fff}ajf-fb-node-properties .ajf-emph{font-style:italic}ajf-fb-node-properties [mat-raised-button]{margin:.5em 0}ajf-fb-node-properties [mat-raised-button].ajf-pointer{cursor:pointer}ajf-fb-node-properties [mat-raised-button] .ajf-icon-cont{display:flex;flex-direction:row;align-items:center}ajf-fb-node-properties [mat-raised-button] .ajf-icon-cont span{flex:1 1 auto;overflow:hidden;text-overflow:ellipsis;display:block;min-height:36px}ajf-fb-node-properties .ajf-validation-row{margin:.5em 0;display:flex;flex-direction:row;align-items:center}ajf-fb-node-properties .ajf-validation-row button{flex:1 1 auto}ajf-fb-node-properties .ajf-validation-row mat-icon{flex:0 0 auto}ajf-fb-node-properties .ajf-prop{margin:.5em 0}ajf-fb-node-properties [mat-raised-button],ajf-fb-node-properties mat-form-field,ajf-fb-node-properties mat-slider{width:100%}"],encapsulation:o.ViewEncapsulation.None,changeDetection:o.ChangeDetectionStrategy.OnPush}]}],yi.ctorParameters=function(){return[{type:K},{type:d.MatDialog},{type:j.FormBuilder}]},yi);function yi(i,t,e){var n=this;this._service=i,this._dialog=t,this._fb=e,this._fieldSizes=[{label:"Normal",value:"normal"},{label:"Small",value:"small"},{label:"Smaller",value:"smaller"},{label:"Tiny",value:"tiny"},{label:"Mini",value:"mini"}],this._choicesOrigins=[],this._conditionalBranches=[],this._validationConditions=[],this._warningConditions=[],this.isRepeatingContainerNode=F.isRepeatingContainerNode,this._visibilitySub=O.Subscription.EMPTY,this._conditionalBranchesSub=O.Subscription.EMPTY,this._formulaRepsSub=O.Subscription.EMPTY,this._choicesFilterSub=O.Subscription.EMPTY,this._formulaSub=O.Subscription.EMPTY,this._forceValueSub=O.Subscription.EMPTY,this._validationConditionsSub=O.Subscription.EMPTY,this._warningConditionsSub=O.Subscription.EMPTY,this._nextSlideConditionSub=O.Subscription.EMPTY,this._choicesOriginsSub=O.Subscription.EMPTY,this._triggerConditionsSub=O.Subscription.EMPTY,this._editConditionDialogSub=O.Subscription.EMPTY,this._editValidationConditionDialogSub=O.Subscription.EMPTY,this._editWarningConditionDialogSub=O.Subscription.EMPTY,this._editVisibilityEvt=new o.EventEmitter,this._editVisibilitySub=O.Subscription.EMPTY,this._editConditionalBranchEvt=new o.EventEmitter,this._editConditionalBranchSub=O.Subscription.EMPTY,this._editFormulaRepsEvt=new o.EventEmitter,this._editFormulaRepsSub=O.Subscription.EMPTY,this._editChoicesFilterEvt=new o.EventEmitter,this._editChoicesFilterSub=O.Subscription.EMPTY,this._editFormulaEvt=new o.EventEmitter,this._editFormulaSub=O.Subscription.EMPTY,this._editForceValueEvt=new o.EventEmitter,this._editForceValueSub=O.Subscription.EMPTY,this._editValidationConditionEvt=new o.EventEmitter,this._editValidationConditionSub=O.Subscription.EMPTY,this._addValidationConditionEvt=new o.EventEmitter,this._addValidationConditionSub=O.Subscription.EMPTY,this._removeValidationConditionEvt=new o.EventEmitter,this._removeValidationConditionSub=O.Subscription.EMPTY,this._editWarningConditionEvt=new o.EventEmitter,this._editWarningConditionSub=O.Subscription.EMPTY,this._addWarningConditionEvt=new o.EventEmitter,this._addWarningConditionSub=O.Subscription.EMPTY,this._removeWarningConditionEvt=new o.EventEmitter,this._removeWarningConditionSub=O.Subscription.EMPTY,this._editNextSlideConditionEvt=new o.EventEmitter,this._editNextSlideConditionSub=O.Subscription.EMPTY,this._editTriggerConditionEvt=new o.EventEmitter,this._editTriggerConditionSub=O.Subscription.EMPTY,this._addTriggerConditionEvt=new o.EventEmitter,this._addTriggerConditionSub=O.Subscription.EMPTY,this._removeTriggerConditionEvt=new o.EventEmitter,this._removeTriggerConditionSub=O.Subscription.EMPTY,this._saveEvt=new o.EventEmitter,this._saveSub=O.Subscription.EMPTY,this._nodeEntry=i.editedNodeEntry,this._choicesOriginsSub=i.choicesOrigins.subscribe(function(i){return n._choicesOrigins=i||[]}),this._enabled=this._nodeEntry.pipe(D.map(function(i){return null!=i})),this._initForm(),this._initVisibilityEdit(),this._initConditionalBranchEdit(),this._initFormulaRepsEdit(),this._initChoicesFilterEdit(),this._initFormulaEdit(),this._initForceValueEdit(),this._initValidationConditionEdit(),this._initAddValidationCondition(),this._initRemoveValidationCondition(),this._initWarningConditionEdit(),this._initAddWarningCondition(),this._initRemoveWarningCondition(),this._initNextSlideConditionEdit(),this._initTriggerConditionEdit(),this._initAddTriggerCondition(),this._initRemoveTriggerCondition(),this._initSave()}var Ci=(Object.defineProperty(Si.prototype,"nodeType",{get:function(){return this._nodeType},set:function(i){this._nodeType=i,this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Si.decorators=[{type:o.Component,args:[{selector:"ajf-fb-node-type-entry",template:'<ng-container *ngIf="nodeType"><mat-icon [fontSet]="nodeType.icon.fontSet" [fontIcon]="nodeType.icon.fontIcon"></mat-icon>{{ nodeType.label }}</ng-container>',styles:["ajf-fb-node-type-entry{display:block;padding:1em 1.5em}ajf-fb-node-type-entry mat-icon{vertical-align:middle}"],encapsulation:o.ViewEncapsulation.None,changeDetection:o.ChangeDetectionStrategy.OnPush}]}],Si.ctorParameters=function(){return[{type:o.ChangeDetectorRef}]},Si.propDecorators={nodeType:[{type:o.Input}]},Si);function Si(i){this._cdr=i}var ji=(Ei.decorators=[{type:o.NgModule,args:[{imports:[t.CommonModule,j.FormsModule,j.ReactiveFormsModule,e.DragDropModule,n.MatAutocompleteModule,r.MatButtonModule,a.MatCardModule,s.MatCheckboxModule,l.MatChipsModule,d.MatDialogModule,c.MatFormFieldModule,u.MatIconModule,p.MatInputModule,f.MatListModule,h.MatMenuModule,m.MatSelectModule,g.MatSidenavModule,b.MatSliderModule,v.MatTableModule,_.MatToolbarModule,y.MatTooltipModule,C.TranslateModule,S.AjfMonacoEditorModule,E.AjfNodeIconModule],declarations:[P,X,Y,ni,ti,ci,_i,Ci,ri,pi,hi,si],exports:[si],entryComponents:[X,ni,ri,pi,hi],providers:[K]}]}],Ei);function Ei(){}i.AjfFormBuilder=si,i.AjfFormBuilderModule=ji,i.AjfFormBuilderService=K,i.flattenNodes=$,i.ɵa=P,i.ɵb=X,i.ɵc=Y,i.ɵd=ni,i.ɵe=ti,i.ɵf=ci,i.ɵg=_i,i.ɵh=Ci,i.ɵi=ri,i.ɵj=pi,i.ɵk=hi,Object.defineProperty(i,"__esModule",{value:!0})});
//# sourceMappingURL=material-form-builder.umd.min.js.map

/**
 * @license
 * Copyright (C) 2018 Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
!function(i,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/common"),require("@angular/core"),require("@angular/forms"),require("@angular/cdk/drag-drop"),require("@angular/material/autocomplete"),require("@angular/material/button"),require("@angular/material/card"),require("@angular/material/checkbox"),require("@angular/material/chips"),require("@angular/material/dialog"),require("@angular/material/form-field"),require("@angular/material/icon"),require("@angular/material/input"),require("@angular/material/list"),require("@angular/material/menu"),require("@angular/material/select"),require("@angular/material/sidenav"),require("@angular/material/slider"),require("@angular/material/table"),require("@angular/material/toolbar"),require("@angular/material/tooltip"),require("@ngx-translate/core"),require("@ajf/material/monaco-editor"),require("@ajf/material/node-icon"),require("rxjs/operators"),require("@ajf/core/forms"),require("@angular/cdk/collections"),require("rxjs"),require("@ajf/core/models"),require("@ajf/core/utils"),require("@angular/cdk/keycodes")):"function"==typeof define&&define.amd?define("@ajf/material/form-builder",["exports","@angular/common","@angular/core","@angular/forms","@angular/cdk/drag-drop","@angular/material/autocomplete","@angular/material/button","@angular/material/card","@angular/material/checkbox","@angular/material/chips","@angular/material/dialog","@angular/material/form-field","@angular/material/icon","@angular/material/input","@angular/material/list","@angular/material/menu","@angular/material/select","@angular/material/sidenav","@angular/material/slider","@angular/material/table","@angular/material/toolbar","@angular/material/tooltip","@ngx-translate/core","@ajf/material/monaco-editor","@ajf/material/node-icon","rxjs/operators","@ajf/core/forms","@angular/cdk/collections","rxjs","@ajf/core/models","@ajf/core/utils","@angular/cdk/keycodes"],e):e(((i=i||self).ajf=i.ajf||{},i.ajf.material=i.ajf.material||{},i.ajf.material.formBuilder={}),i.ng.common,i.ng.core,i.ng.forms,i.ng.cdk.dragDrop,i.ng.material.autocomplete,i.ng.material.button,i.ng.material.card,i.ng.material.checkbox,i.ng.material.chips,i.ng.material.dialog,i.ng.material.formField,i.ng.material.icon,i.ng.material.input,i.ng.material.list,i.ng.material.menu,i.ng.material.select,i.ng.material.sidenav,i.ng.material.slider,i.ng.material.table,i.ng.material.toolbar,i.ng.material.tooltip,i.ngxt.core,i.ajf.material.monacoEditor,i.ajf.material.nodeIcon,i.rxjs.operators,i.ajf.core.forms,i.ng.cdk.collections,i.rxjs,i.ajf.core.models,i.ajf.core.utils,i.ng.cdk.keycodes)}(this,function(i,e,o,j,t,n,a,r,s,l,d,c,u,p,f,h,m,g,b,v,_,y,C,S,E,x,F,D,O,w,N,T){"use strict";var V=function(i,e){return(V=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,e){i.__proto__=e}||function(i,e){for(var t in e)e.hasOwnProperty(t)&&(i[t]=e[t])})(i,e)};var M=function(){return(M=Object.assign||function(i){for(var e,t=1,n=arguments.length;t<n;t++)for(var o in e=arguments[t])Object.prototype.hasOwnProperty.call(e,o)&&(i[o]=e[o]);return i}).apply(this,arguments)},P=(Object.defineProperty(I.prototype,"offset",{set:function(i){this._offset=i,this._updateOffset()},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,"color",{set:function(i){this._color=i,this._updateColor()},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,"height",{set:function(i){this._height=i,this._updateHeight()},enumerable:!0,configurable:!0}),I.prototype._updateHeight=function(){var i=Math.max(0,this._height-25)+"px";this._renderer.setStyle(this._el.nativeElement,"height",i)},I.prototype._updateOffset=function(){var i=4*this._offset+"px";this._renderer.setStyle(this._el.nativeElement,"margin-top",i),this._renderer.setStyle(this._el.nativeElement,"margin-left",i)},I.prototype._updateColor=function(){this._renderer.setStyle(this._el.nativeElement,"border-color",this._color)},I.decorators=[{type:o.Component,args:[{selector:"ajf-fb-branch-line",template:"",styles:["ajf-fb-branch-line{display:block;position:absolute;top:25px;left:25px;width:25px;border-top:2px solid;border-left:2px solid;border-top-left-radius:6px}"],encapsulation:o.ViewEncapsulation.None,changeDetection:o.ChangeDetectionStrategy.OnPush}]}],I.ctorParameters=function(){return[{type:o.ElementRef},{type:o.Renderer2}]},I.propDecorators={offset:[{type:o.Input}],color:[{type:o.Input}],height:[{type:o.Input}]},I);function I(i,e){this._el=i,this._renderer=e,this._offset=0,this._height=0}var k,A,R,B=(R=D.DataSource,V(k=L,A=R),void(k.prototype=null===A?Object.create(A):(W.prototype=A.prototype,new W)),L.prototype.connect=function(){return this._choicesObs},L.prototype.disconnect=function(){},L.prototype.updateChoices=function(i){this._choices.next(i)},L);function W(){this.constructor=k}function L(){var i=R.call(this)||this;return i._choices=new O.BehaviorSubject([]),i._choicesObs=i._choices.asObservable(),i}var Y=(Object.defineProperty(U.prototype,"displayedColumns",{get:function(){return this._displayedColumns},enumerable:!0,configurable:!0}),Object.defineProperty(U.prototype,"choicesOrigin",{get:function(){return this._choicesOrigin},set:function(i){this._choicesOrigin=i,this.name=i.name,this.label=i.label,this.canEditChoices=F.isChoicesFixedOrigin(i),this._choicesArr=i.choices,this._choices.updateChoices(this._choicesArr)},enumerable:!0,configurable:!0}),Object.defineProperty(U.prototype,"choices",{get:function(){return this._choices},enumerable:!0,configurable:!0}),Object.defineProperty(U.prototype,"choicesArr",{get:function(){return this._choicesArr},enumerable:!0,configurable:!0}),U.prototype.updateValue=function(i,e,t,n){this.editing[n+"-"+e]=!1,this._choicesArr[n][e]=i.target.value,this._choices.updateChoices(this._choicesArr)},U.prototype.deleteRow=function(i){this._choicesArr.splice(i,1),this._choices.updateChoices(this._choicesArr)},U.prototype.addRow=function(){this._choicesArr.push({label:"",value:""}),this._choices.updateChoices(this._choicesArr)},U.decorators=[{type:o.Component,args:[{selector:"ajf-fb-choices-origin-editor",template:'<div><mat-form-field><input matInput [(ngModel)]="name" [placeholder]="\'Name\' | translate"></mat-form-field><mat-form-field><input matInput [(ngModel)]="label" [placeholder]="\'Label\' | translate"></mat-form-field><ng-template [ngIf]="canEditChoices"><button (click)="addRow()" mat-button><mat-icon>add</mat-icon><span translate>Add value</span></button><mat-table [dataSource]="choices"><ng-container matColumnDef="label"><mat-header-cell *matHeaderCellDef translate>Label</mat-header-cell><mat-cell *matCellDef="let row; let idx = index"><span [title]="\'Double click to edit\' | translate" (dblclick)="editing[idx + \'-label\'] = true" *ngIf="!editing[idx + \'-label\']"><span *ngIf="row.label">{{ row.label }}</span> <span *ngIf="!row.label" translate>(no label)</span> </span><input autofocus #in1 (blur)="updateValue($event, \'label\', in1.value, idx)" *ngIf="editing[idx + \'-label\']" type="text" [value]="row.label"></mat-cell></ng-container><ng-container matColumnDef="value"><mat-header-cell *matHeaderCellDef translate>Value</mat-header-cell><mat-cell *matCellDef="let row; let idx = index"><span [title]="\'Double click to edit\' | translate" (dblclick)="editing[idx + \'-value\'] = true" *ngIf="!editing[idx + \'-value\']"><span *ngIf="row.value">{{ row.value }}</span> <span *ngIf="!row.value" translate>(no value)</span> </span><input autofocus #in2 (blur)="updateValue($event, \'value\', in2.value, idx)" *ngIf="editing[idx + \'-value\']" type="text" [value]="row.value"></mat-cell></ng-container><ng-container matColumnDef="delete"><mat-header-cell *matHeaderCellDef translate>Delete</mat-header-cell><mat-cell *matCellDef="let row; let idx = index"><mat-icon (click)="deleteRow(idx)">delete</mat-icon></mat-cell></ng-container><mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row><mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row></mat-table></ng-template></div>',styles:["ajf-fb-choices-origin-editor mat-form-field+mat-form-field{margin-left:1em}ajf-fb-choices-origin-editor mat-table{max-height:300px}ajf-fb-choices-origin-editor mat-table mat-icon{cursor:pointer}"],encapsulation:o.ViewEncapsulation.None,changeDetection:o.ChangeDetectionStrategy.OnPush}]}],U.propDecorators={choicesOrigin:[{type:o.Input}]},U);function U(){this._displayedColumns=["label","value","delete"],this.editing={},this._choices=new B,this._choicesArr=[]}function q(i,e){if(-1<i.nodes.indexOf(e))return i;for(var t=i.nodes.filter(function(i){return F.isContainerNode(i)}),n=t.length,o=0;o<n;o++){var a=q(t[o],e);if(null!=a)return a}return null}function z(t,e,i){void 0===i&&(i=!1);var n=t.filter(function(i){return i.parent===e.id}).sort(function(i,e){return i.parentNode-e.parentNode}).map(function(i){var e=z(t,i);return 0===e.length&&e.push({parent:i,parentNode:0}),{node:i,children:e,content:H(t,i)}});if(!i)for(var o=n.length,a=e.conditionalBranches.length,r=o;r<a;r++)n.push({parent:e,parentNode:r});return n}function H(i,e){return F.isContainerNode(e)?z(e.nodes,e,!0):[]}function $(i){var e=[];return i.forEach(function(i){F.isContainerNode(i)&&(e=e.concat($(i.nodes))),e.push(i)}),e}function J(i,e,t){return void 0===t&&(t=null),null!=t?i.filter(function(i){return i.parent===e.id&&i.parentNode===t}):i.filter(function(i){return i.parent===e.id})}function Z(i,e,t){void 0===t&&(t=null);for(var n=$(i),o=[],a=J(n,e,t),r=a.length,s=0;s<r;s++)o=o.concat(J(n,a[s]));return function i(e,t){for(var n=e.length,o=0;o<n;o++){var a=e[o];if(F.isContainerNode(a)){var r=a;r.nodes=i(r.nodes,t)}}return e.filter(function(i){return-1===t.indexOf(i.id)})}(i,(o=o.concat(a)).map(function(i){return i.id}))}var G=0,K=(Object.defineProperty(Q.prototype,"availableNodeTypes",{get:function(){return this._availableNodeTypes},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"form",{get:function(){return this._formObs},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"attachmentsOrigins",{get:function(){return this._attachmentsOrigins},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"choicesOrigins",{get:function(){return this._choicesOrigins},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"stringIdentifier",{get:function(){return this._stringIdentifier},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"nodes",{get:function(){return this._nodes},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"flatNodes",{get:function(){return this._flatNodes},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"flatFields",{get:function(){return this._flatFields},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"nodeEntriesTree",{get:function(){return this._nodeEntriesTree},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"editedNodeEntry",{get:function(){return this._editedNodeEntryObs},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"editedCondition",{get:function(){return this._editedConditionObs},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"editedChoicesOrigin",{get:function(){return this._editedChoicesOriginObs},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"beforeNodesUpdate",{get:function(){return this._beforeNodesUpdateObs},enumerable:!0,configurable:!0}),Object.defineProperty(Q.prototype,"afterNodeUpdate",{get:function(){return this._afterNodeUpdateObs},enumerable:!0,configurable:!0}),Q.prototype.setForm=function(i){i!==this._form.getValue()&&this._form.next(i)},Q.prototype.editNodeEntry=function(i){this._editedNodeEntry.next(i)},Q.prototype.editCondition=function(i){this._editedCondition.next(i)},Q.prototype.saveCurrentCondition=function(i){var e=this._editedCondition.getValue();null!=e&&(e.condition=i,this._editedCondition.next(null))},Q.prototype.cancelConditionEdit=function(){this._editedChoicesOrigin.next(null)},Q.prototype.insertNode=function(i,o,e,a){var r;void 0===a&&(a=!1);var t=++G,s=null!=i.nodeType.field;r=s?F.createField({id:t,nodeType:F.AjfNodeType.AjfField,fieldType:i.nodeType.field,parent:o.id,parentNode:e,name:""}):F.createContainerNode({id:t,nodeType:i.nodeType.node,parent:o.id,parentNode:e,name:"",nodes:[]}),this._beforeNodesUpdate.emit(),this._nodesUpdates.next(function(i){var e=F.isContainerNode(o)&&a?o:q({nodes:i},o);if(null!=e)if(s)e.nodes.push(r);else{var t=e.nodes===i,n=e.nodes.slice(0);n.push(r),e.nodes=n,t&&(i=n)}return i})},Q.prototype.saveNodeEntry=function(i){this._saveNodeEntryEvent.emit(i)},Q.prototype.cancelNodeEntryEdit=function(){this._editedNodeEntry.next(null)},Q.prototype.deleteNodeEntry=function(i){this._deleteNodeEntryEvent.next(i)},Q.prototype.getCurrentForm=function(){return O.combineLatest([this.form,this.nodes,this.attachmentsOrigins,this.choicesOrigins,this.stringIdentifier]).pipe(x.filter(function(i){return null!=i[0]}),x.map(function(i){var e=i[0],t=i[1],n=i[2],o=i[3],a=i[4];return F.createForm({choicesOrigins:o.slice(0),attachmentsOrigins:n.slice(0),stringIdentifier:(a||[]).slice(0),nodes:t.slice(0),supplementaryInformations:e.supplementaryInformations})}))},Q.prototype.editChoicesOrigin=function(i){this._editedChoicesOrigin.next(i)},Q.prototype.createChoicesOrigin=function(){this._editedChoicesOrigin.next(F.createChoicesFixedOrigin({name:""}))},Q.prototype.cancelChoicesOriginEdit=function(){this._editedChoicesOrigin.next(null)},Q.prototype.saveChoicesOrigin=function(i){var t=this._editedChoicesOrigin.getValue();null!=t&&(t.label=i.label,t.name=i.name,F.isChoicesFixedOrigin(t)&&(t.choices=i.choices),this._choicesOriginsUpdates.next(function(i){var e=i.indexOf(t);return i=-1<e?i.slice(0,e).concat([t],i.slice(e+1)):i.concat([t])})),this._editedChoicesOrigin.next(null)},Q.prototype.saveStringIdentifier=function(i){this._stringIdentifierUpdates.next(function(){return i.slice()})},Q.prototype._findMaxNodeId=function(i,e){var t=this,n=0;return i.forEach(function(i){n=Math.max(n,i.id),F.isContainerNode(i)&&(n=Math.max(n,t._findMaxNodeId(i.nodes)))}),n},Q.prototype._initFormStreams=function(){var i=this;this._form.subscribe(function(e){G=0,null!=e&&null!=e.nodes&&0<e.nodes.length&&(G=i._findMaxNodeId(e.nodes)),i._nodesUpdates.next(function(i){return null!=e&&null!=e.nodes?e.nodes.slice(0):[]}),i._attachmentsOriginsUpdates.next(function(i){return null!=e&&null!=e.attachmentsOrigins?e.attachmentsOrigins.slice(0):[]}),i._choicesOriginsUpdates.next(function(i){return null!=e&&null!=e.choicesOrigins?e.choicesOrigins.slice(0):[]}),i._stringIdentifierUpdates.next(function(i){return null!=e&&null!=e.stringIdentifier?e.stringIdentifier.slice(0):[]})})},Q.prototype._initChoicesOriginsStreams=function(){this._choicesOrigins=this._choicesOriginsUpdates.pipe(x.scan(function(i,e){return e(i)},[]),x.publishReplay(1),x.refCount())},Q.prototype._initAttachmentsOriginsStreams=function(){this._attachmentsOrigins=this._attachmentsOriginsUpdates.pipe(x.scan(function(i,e){return e(i)},[]),x.publishReplay(1),x.refCount())},Q.prototype._initStringIdentifierStreams=function(){this._stringIdentifier=this._stringIdentifierUpdates.pipe(x.scan(function(i,e){return e(i)},[]),x.publishReplay(1),x.refCount())},Q.prototype._initNodesStreams=function(){this._nodes=this._nodesUpdates.pipe(x.scan(function(i,e){return e(i)},[]),x.publishReplay(1),x.refCount()),this._flatNodes=this._nodes.pipe(x.map(function(i){return $(i)}),x.publishReplay(1),x.refCount()),this._flatFields=this._flatNodes.pipe(x.map(function(i){return i.filter(function(i){return!F.isContainerNode(i)})}),x.publishReplay(1),x.refCount()),this._nodeEntriesTree=this._nodes.pipe(x.map(function(i){return function(i){var e=i.filter(function(i){return null==i.parent||0===i.parent});if(1===e.length){var t=e[0];if(F.isSlidesNode(t)){var n=[];return n.push({node:t,container:null,children:z(i,t),content:H(0,t)}),n}}else if(0===e.length)return[null];throw new Error("Invalid form definition")}(i)}),x.publishReplay(1),x.refCount())},Q.prototype._initSaveNode=function(){var D=this;this._saveNodeEntryEvent.pipe(x.withLatestFrom(this.editedNodeEntry,this.choicesOrigins,this.attachmentsOrigins),x.filter(function(i){return null!=i[1]}),x.map(function(i){D._beforeNodesUpdate.emit();var e=i[0],t=i[1],n=i[2],r=t.node,s=N.deepCopy(r);s.id=t.node.id,s.name=e.name,s.label=e.label,s.visibility=null!=e.visibility?w.createCondition({condition:e.visibility}):null;var l=s.conditionalBranches.length;s.conditionalBranches=null!=e.conditionalBranches?e.conditionalBranches.map(function(i){return w.createCondition({condition:i})}):[w.alwaysCondition()];var d=s.conditionalBranches.length;if(F.isRepeatingContainerNode(s)){var o=s;o.formulaReps=null!=e.formulaReps?w.createFormula({formula:e.formulaReps}):void 0,o.minReps=e.minReps,o.maxReps=e.maxReps}if(F.isField(s)){var a=s;a.description=e.description,a.defaultValue=e.defaultValue,a.formula=null!=e.formula?w.createFormula({formula:e.formula}):void 0;var c=e.value,u=e.notEmpty,p=e.validationConditions,f=parseInt(e.minValue,10),h=parseInt(e.maxValue,10),m=parseInt(e.minDigits,10),g=parseInt(e.maxDigits,10);if(isNaN(f)&&(f=null),isNaN(h)&&(h=null),isNaN(m)&&(m=null),isNaN(g)&&(g=null),null!=c||null!=u||null!=p&&0<p.length||null!=f||null!=h||null!=m||null!=g){var b=a.validation||F.createValidationGroup({});b.forceValue=c,b.notEmpty=u?F.notEmptyValidation():void 0,b.minValue=null!=f?F.minValidation(f):void 0,b.maxValue=null!=h?F.maxValidation(h):void 0,b.minDigits=null!=m?F.minDigitsValidation(m):void 0,b.maxDigits=null!=g?F.maxDigitsValidation(g):void 0,b.conditions=(p||[]).map(function(i){return F.createValidation({condition:i.condition,errorMessage:i.errorMessage})}),a.validation=b}else a.validation=void 0;var v=e.notEmptyWarning,_=e.warningConditions;if(null!=v||null!=_&&0<_.length){var y=a.warning||F.createWarningGroup({});y.notEmpty=v?F.notEmptyWarning():void 0,y.conditions=(_||[]).map(function(i){return F.createWarning({condition:i.condition,warningMessage:i.warningMessage})}),a.warning=y}else a.warning=void 0;if(a.nextSlideCondition=null!=e.nextSlideCondition?w.createCondition({condition:e.nextSlideCondition}):void 0,F.isFieldWithChoices(a)){for(var C=a,S=null,j=0,E=n.length;null==S&&j<E;)n[j].name===e.choicesOrigin&&(S=n[j]),j++;null!=S&&(C.choicesOrigin=S),C.forceExpanded=e.forceExpanded,C.forceNarrow=e.forceNarrow,C.triggerConditions=(e.triggerConditions||[]).map(function(i){return w.createCondition({condition:i})})}}return D._editedNodeEntry.next(null),function(i){var e=q({nodes:i},r);if(null!=e){var t=e.nodes===i,n=e.nodes.indexOf(r),o=e.nodes.slice(0,n);if(o.push(s),o=o.concat(e.nodes.slice(n+1)),e.nodes=o,i=t?o:i.slice(0),d<l)for(var a=d;a<l;a++)i=Z(i,s,a)}return i}})).subscribe(this._nodesUpdates)},Q.prototype._initDeleteNode=function(){var i=this;this._deleteNodeEntryEvent.pipe(x.map(function(a){return i._beforeNodesUpdate.emit(),function(i){var e=a.node,t=q({nodes:i},e);if(null!=t){var n=t.nodes.indexOf(e),o=t.nodes.slice(0,n);o=o.concat(t.nodes.slice(n+1)),t.nodes=o,i=Z(i=i.slice(0),e)}return i}})).subscribe(this._nodesUpdates)},Q.decorators=[{type:o.Injectable}],Q.ctorParameters=function(){return[]},Q);function Q(){this._availableNodeTypes=[{label:"Slide",icon:{fontSet:"ajf-icon",fontIcon:"field-slide"},nodeType:{node:F.AjfNodeType.AjfSlide},isSlide:!0},{label:"Repeating slide",icon:{fontSet:"ajf-icon",fontIcon:"field-repeatingslide"},nodeType:{node:F.AjfNodeType.AjfRepeatingSlide},isSlide:!0},{label:"String",icon:{fontSet:"ajf-icon",fontIcon:"field-string"},nodeType:{node:F.AjfNodeType.AjfField,field:F.AjfFieldType.String}},{label:"Text",icon:{fontSet:"ajf-icon",fontIcon:"field-text"},nodeType:{node:F.AjfNodeType.AjfField,field:F.AjfFieldType.Text}},{label:"Number",icon:{fontSet:"ajf-icon",fontIcon:"field-number"},nodeType:{node:F.AjfNodeType.AjfField,field:F.AjfFieldType.Number}},{label:"Boolean",icon:{fontSet:"ajf-icon",fontIcon:"field-boolean"},nodeType:{node:F.AjfNodeType.AjfField,field:F.AjfFieldType.Boolean}},{label:"Single choice",icon:{fontSet:"ajf-icon",fontIcon:"field-singlechoice"},nodeType:{node:F.AjfNodeType.AjfField,field:F.AjfFieldType.SingleChoice}},{label:"Multiple choice",icon:{fontSet:"ajf-icon",fontIcon:"field-multiplechoice"},nodeType:{node:F.AjfNodeType.AjfField,field:F.AjfFieldType.MultipleChoice}},{label:"Formula",icon:{fontSet:"ajf-icon",fontIcon:"field-formula"},nodeType:{node:F.AjfNodeType.AjfField,field:F.AjfFieldType.Formula}},{label:"Date",icon:{fontSet:"ajf-icon",fontIcon:"field-date"},nodeType:{node:F.AjfNodeType.AjfField,field:F.AjfFieldType.Date}},{label:"Date input",icon:{fontSet:"ajf-icon",fontIcon:"field-dateinput"},nodeType:{node:F.AjfNodeType.AjfField,field:F.AjfFieldType.DateInput}},{label:"Time",icon:{fontSet:"ajf-icon",fontIcon:"field-time"},nodeType:{node:F.AjfNodeType.AjfField,field:F.AjfFieldType.Time}},{label:"Table",icon:{fontSet:"ajf-icon",fontIcon:"field-table"},nodeType:{node:F.AjfNodeType.AjfField,field:F.AjfFieldType.Table}}],this._form=new O.BehaviorSubject(null),this._formObs=this._form.asObservable(),this._editedNodeEntry=new O.BehaviorSubject(null),this._editedNodeEntryObs=this._editedNodeEntry.asObservable(),this._editedCondition=new O.BehaviorSubject(null),this._editedConditionObs=this._editedCondition.asObservable(),this._editedChoicesOrigin=new O.BehaviorSubject(null),this._editedChoicesOriginObs=this._editedChoicesOrigin.asObservable(),this._beforeNodesUpdate=new o.EventEmitter,this._beforeNodesUpdateObs=this._beforeNodesUpdate.asObservable(),this._afterNodeUpdate=new o.EventEmitter,this._afterNodeUpdateObs=this._afterNodeUpdate.asObservable(),this._nodesUpdates=new O.Subject,this._attachmentsOriginsUpdates=new O.Subject,this._choicesOriginsUpdates=new O.Subject,this._stringIdentifierUpdates=new O.Subject,this._saveNodeEntryEvent=new o.EventEmitter,this._deleteNodeEntryEvent=new o.EventEmitter,this._initChoicesOriginsStreams(),this._initAttachmentsOriginsStreams(),this._initStringIdentifierStreams(),this._initNodesStreams(),this._initFormStreams(),this._initSaveNode(),this._initDeleteNode()}var X=(Object.defineProperty(ii.prototype,"choicesOrigin",{get:function(){return this._choicesOrigin},enumerable:!0,configurable:!0}),ii.prototype.saveChoicesOrigin=function(){this._service.saveChoicesOrigin({label:this.editor.label,name:this.editor.name,choices:this.editor.choicesArr})},ii.prototype.cancelChoicesOriginEdit=function(){this._service.cancelChoicesOriginEdit()},ii.decorators=[{type:o.Component,args:[{selector:"ajf-fb-choices-origin-editor-dialog",template:'<h3 matDialogTitle translate>Edit choices origin</h3><mat-dialog-content><ajf-fb-choices-origin-editor [choicesOrigin]="choicesOrigin|async"></ajf-fb-choices-origin-editor></mat-dialog-content><mat-dialog-actions><button mat-button translate (click)="saveChoicesOrigin()">Save</button> <button mat-button translate (click)="cancelChoicesOriginEdit()">Close</button></mat-dialog-actions>',styles:[""],encapsulation:o.ViewEncapsulation.None,changeDetection:o.ChangeDetectionStrategy.OnPush}]}],ii.ctorParameters=function(){return[{type:K}]},ii.propDecorators={editor:[{type:o.ViewChild,args:[Y,{static:!0}]}]},ii);function ii(i){this._service=i,this._choicesOrigin=this._service.editedChoicesOrigin.pipe(x.filter(function(i){return null!=i}),x.map(function(i){return i}))}var ei=(Object.defineProperty(ti.prototype,"fields",{get:function(){return this._fields},set:function(i){this._fields=i,this._updateVariables()},enumerable:!0,configurable:!0}),ti.prototype.insertVariable=function(i){if(null!=this.monacoEditor&&null!=this.monacoEditor.editor){var e=this.monacoEditor.editor,t=e.getValue().split("\n"),n=e.getPosition(),o=n.lineNumber-1,a=t[o],r=n.column-1;a=a.substring(0,r)+i+a.substring(r),t[o]=a,n.column+=i.length,this.monacoEditor.value=t.join("\n"),e.setPosition(n),e.focus(),this.editedValue=e.getValue()}},ti.prototype.onEditorInit=function(){monaco.languages.typescript.javascriptDefaults.setDiagnosticsOptions({noSemanticValidation:!1,noSyntaxValidation:!1}),monaco.languages.typescript.javascriptDefaults.setCompilerOptions({target:monaco.languages.typescript.ScriptTarget.ES2015,allowNonTsExtensions:!0,allowJs:!0,module:monaco.languages.typescript.ModuleKind.None});try{monaco.languages.typescript.javascriptDefaults.addExtraLib("","condition-editor-variables.d.ts")}catch(i){monaco.languages.typescript.javascriptDefaults._extraLibs["condition-editor-variables.d.ts"]=""}try{monaco.languages.typescript.javascriptDefaults.addExtraLib("","condition-editor-functions.d.ts")}catch(i){monaco.languages.typescript.javascriptDefaults._extraLibs["condition-editor-functions.d.ts"]=""}this._updateVariables(),this._updateFunctions()},ti.prototype._updateVariables=function(){var e=this;if(null!=this._fields)try{monaco.languages.typescript.javascriptDefaults._extraLibs["condition-editor-variables.d.ts"]=this._fields.map(function(i){return"declare const "+i.name+": "+e._fieldVarType(i.fieldType)+";"}).join("\n")}catch(i){}},ti.prototype._updateFunctions=function(){try{monaco.languages.typescript.javascriptDefaults._extraLibs["condition-editor-functions.d.ts"]=w.AjfExpressionUtils.UTIL_FUNCTIONS}catch(i){}},ti.prototype._fieldVarType=function(i){switch(i){case F.AjfFieldType.Boolean:return"boolean";case F.AjfFieldType.Date:case F.AjfFieldType.DateInput:case F.AjfFieldType.Time:return"Date";case F.AjfFieldType.Empty:return"void";case F.AjfFieldType.Formula:return"number";case F.AjfFieldType.MultipleChoice:case F.AjfFieldType.SingleChoice:return"any";case F.AjfFieldType.Number:return"number";case F.AjfFieldType.Table:return"Array";case F.AjfFieldType.String:case F.AjfFieldType.Text:return"string"}return null},ti.decorators=[{type:o.Component,args:[{selector:"ajf-condition-editor",template:'<div class="ajf-editor"><ajf-monaco-editor (init)="onEditorInit()" (valueChange)="editedValue = $event" [value]="condition" language="javascript"></ajf-monaco-editor></div><div class="ajf-editor-panel"><mat-nav-list dense *ngIf="fields?.length > 0"><a mat-list-item (click)="insertVariable(field.name)" [matTooltip]="field.label" *ngFor="let field of fields"><ajf-node-icon [node]="field"></ajf-node-icon>{{ field.name }}</a></mat-nav-list></div>',styles:["ajf-condition-editor{display:flex;flex-direction:row;align-items:stretch;max-height:512px}ajf-condition-editor .ajf-editor{flex:.75 0 auto;display:flex;flex-direction:row;align-items:stretch}ajf-condition-editor .ajf-editor monaco-editor{flex:1 0 auto;min-width:512px;min-height:256px}ajf-condition-editor .ajf-editor-panel{flex:.25 0 auto;overflow-y:auto}ajf-condition-editor ajf-monaco-editor{min-width:400px}"],changeDetection:o.ChangeDetectionStrategy.OnPush,encapsulation:o.ViewEncapsulation.None}]}],ti.ctorParameters=function(){return[{type:F.AjfValidationService}]},ti.propDecorators={monacoEditor:[{type:o.ViewChild,args:[S.AjfMonacoEditor,{static:!0}]}],fields:[{type:o.Input}],condition:[{type:o.Input}]},ti);function ti(i){}var ni=(Object.defineProperty(oi.prototype,"fields",{get:function(){return this._fields},enumerable:!0,configurable:!0}),oi.prototype.saveCondition=function(){if(null!=this.editor){var i=this.editor.editedValue;this.dialogRef.close(i)}},oi.decorators=[{type:o.Component,args:[{selector:"ajf-condition-editor-dialog",template:'<h3 matDialogTitle translate>Edit condition</h3><mat-dialog-content><ajf-condition-editor [fields]="fields|async" [condition]="condition"></ajf-condition-editor></mat-dialog-content><mat-dialog-actions><button mat-button translate (click)="saveCondition()">Save</button> <button mat-button translate matDialogClose>Close</button></mat-dialog-actions>',styles:["ajf-condition-editor-dialog mat-dialog-content{overflow:visible}"],encapsulation:o.ViewEncapsulation.None,changeDetection:o.ChangeDetectionStrategy.OnPush}]}],oi.ctorParameters=function(){return[{type:K},{type:d.MatDialogRef}]},oi.propDecorators={editor:[{type:o.ViewChild,args:[ei,{static:!0}]}]},oi);function oi(i,e){this.dialogRef=e,this._fields=i.flatFields.pipe(x.map(function(i){return i.sort(function(i,e){return i.name.localeCompare(e.name)})}))}var ai=(ri.prototype.addRow=function(){this.dataSource.data=this.dataSource.data.concat([{label:"",value:[]}])},ri.prototype.deleteRow=function(i){this.dataSource.data=this.dataSource.data.slice(0,i).concat(this.dataSource.data.slice(i+1))},ri.prototype.addValue=function(i,e,t){0!==e.value.length&&(i.value=i.value.concat([e.value]),t.value="",this._cdr.markForCheck())},ri.prototype.removeValue=function(i,e){var t=i.value.indexOf(e);-1<t&&(i.value=i.value.slice(0,t).concat(i.value.slice(t+1)),this._cdr.markForCheck())},ri.prototype.ngOnDestroy=function(){this._stringIdentifierSub.unsubscribe()},ri.prototype.saveStringIdentifier=function(){this._service.saveStringIdentifier(this.dataSource.data)},ri.prototype.selected=function(i,e){i.value=i.value.concat([e.option.value]),this._cdr.markForCheck()},ri.decorators=[{type:o.Component,args:[{selector:"ajf-fb-string-identifier-dialog",template:'<h3 matDialogTitle translate>Edit identifier</h3><mat-dialog-content><button (click)="addRow()" mat-button><mat-icon>add</mat-icon><span translate>Add value</span></button><mat-table [dataSource]="dataSource"><ng-container matColumnDef="label"><mat-header-cell *matHeaderCellDef translate>Label</mat-header-cell><mat-cell *matCellDef="let row; let idx = index"><mat-form-field><input matInput [placeholder]="\'Label\'|translate" autofocus [(ngModel)]="row.label"></mat-form-field></mat-cell></ng-container><ng-container matColumnDef="value"><mat-header-cell *matHeaderCellDef translate>Value</mat-header-cell><mat-cell *matCellDef="let row; let idx = index"><mat-form-field><mat-chip-list #chipList><mat-chip *ngFor="let field of row.value" (removed)="removeValue(row, field)">{{ field }}<mat-icon matChipRemove>cancel</mat-icon></mat-chip></mat-chip-list><input #valueInput [ngModel]="row.value" [matAutocomplete]="valueAc" [matChipInputFor]="chipList" [matChipInputSeparatorKeyCodes]="separatorKeysCodes" [matChipInputAddOnBlur]="true" (matChipInputTokenEnd)="addValue(row, $event, valueInput)" [placeholder]="\'Value\'|translate"><mat-autocomplete #valueAc="matAutocomplete" (optionSelected)="selected(row, $event)"><mat-option *ngFor="let field of fields$ | async" [value]="field">{{field}}</mat-option></mat-autocomplete></mat-form-field></mat-cell></ng-container><ng-container matColumnDef="delete"><mat-header-cell *matHeaderCellDef translate>Delete</mat-header-cell><mat-cell *matCellDef="let row; let idx = index"><mat-icon (click)="deleteRow(idx)">delete</mat-icon></mat-cell></ng-container><mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row><mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row></mat-table></mat-dialog-content><mat-dialog-actions><button mat-button translate matDialogClose (click)="saveStringIdentifier()">Save</button></mat-dialog-actions>',styles:[""],changeDetection:o.ChangeDetectionStrategy.OnPush,encapsulation:o.ViewEncapsulation.None}]}],ri.ctorParameters=function(){return[{type:K},{type:o.ChangeDetectorRef}]},ri);function ri(i,e){var t=this;this._service=i,this._cdr=e,this.dataSource=new v.MatTableDataSource,this.displayedColumns=["label","value","delete"],this.separatorKeysCodes=[T.ENTER,T.COMMA],this._stringIdentifierSub=O.Subscription.EMPTY,this._stringIdentifierSub=i.stringIdentifier.subscribe(function(i){t.dataSource.data=i.slice()}),this.fields$=i.flatFields.pipe(x.map(function(i){return i.sort(function(i,e){return i.name.localeCompare(e.name)}).map(function(i){return i.name}).filter(function(i){return 0<i.length})}),x.shareReplay(1))}var si=(Object.defineProperty(li.prototype,"form",{get:function(){return this._form},set:function(i){this._form!==i&&(this._form=i,this._init&&this._setCurrentForm())},enumerable:!0,configurable:!0}),Object.defineProperty(li.prototype,"nodeTypes",{get:function(){return this._nodeTypes},enumerable:!0,configurable:!0}),Object.defineProperty(li.prototype,"nodeEntriesTree",{get:function(){return this._nodeEntriesTree},enumerable:!0,configurable:!0}),Object.defineProperty(li.prototype,"choicesOrigins",{get:function(){return this._choicesOrigins},enumerable:!0,configurable:!0}),li.prototype.ngAfterViewChecked=function(){this._vc.emit()},li.prototype.ngAfterContentInit=function(){this._setCurrentForm(),this._init=!0},li.prototype.ngOnDestroy=function(){this._editConditionSub.unsubscribe(),this._beforeNodesUpdateSub.unsubscribe(),this._editChoicesOriginSub.unsubscribe(),this._stringIdentifierSub.unsubscribe(),this._service.setForm(null)},li.prototype.createChoicesOrigin=function(){this._service.createChoicesOrigin()},li.prototype.disableDropPredicate=function(){return!1},li.prototype.editChoicesOrigin=function(i){this._service.editChoicesOrigin(i)},li.prototype.editStringIdentifier=function(){null!=this._stringIdentifierDialog&&(this._stringIdentifierDialog.close(),this._stringIdentifierDialog=null),this._stringIdentifierDialog=this._dialog.open(ai,{disableClose:!0,width:"60%",height:"60%"})},li.prototype._setCurrentForm=function(){this._service.setForm(this._form)},li.decorators=[{type:o.Component,args:[{selector:"ajf-form-builder",template:'<mat-toolbar><button mat-icon-button (click)="leftSidenav.toggle()"><mat-icon>add_box</mat-icon></button> <button mat-button [matMenuTriggerFor]="choicesMenu" translate>Choices</button> <button mat-button (click)="editStringIdentifier()" translate>Identifier</button><mat-menu #choicesMenu><button (click)="createChoicesOrigin()" mat-menu-item translate>New..</button><ng-container *ngIf="choicesOrigins|async as cos"><button *ngFor="let choicesOrigin of cos" (click)="editChoicesOrigin(choicesOrigin)" mat-menu-item>{{ choicesOrigin.label || choicesOrigin.name }}</button></ng-container></mat-menu><span class="ajf-spacer"></span> <button mat-icon-button (click)="rightSidenav.toggle()"><mat-icon>settings</mat-icon></button></mat-toolbar><mat-drawer-container cdkDropListGroup><mat-drawer #leftSidenav position="start" mode="over"><div #sourceDropList cdkDropList [cdkDropListEnterPredicate]="disableDropPredicate" [cdkDropListData]="nodeTypes"><ajf-fb-node-type-entry *ngFor="let nodeType of nodeTypes" cdkDrag [cdkDragData]="nodeType" (cdkDragStarted)="leftSidenav.close()" [nodeType]="nodeType"></ajf-fb-node-type-entry></div></mat-drawer><mat-drawer #rightSidenav position="end" mode="side" [opened]="true"><ajf-fb-node-properties></ajf-fb-node-properties></mat-drawer><div #designer class="ajf-designer"><ajf-fb-node-entry *ngFor="let nodeEntry of (nodeEntriesTree|async); let isFirst = first" [isFirst]="isFirst" [nodeEntry]="nodeEntry"></ajf-fb-node-entry></div></mat-drawer-container>',styles:["ajf-form-builder mat-toolbar mat-menu div[mat-menu-item]>button[mat-button]{flex:1 0 auto}ajf-form-builder mat-toolbar mat-menu div[mat-menu-item]>button[mat-icon-button]{flex:0 0 auto}ajf-form-builder mat-drawer-container{height:700px}ajf-form-builder mat-drawer-container mat-drawer{max-width:20%}ajf-form-builder mat-drawer-container .ajf-designer{padding:1em;position:absolute;top:0;right:0;bottom:0;left:0;overflow-y:auto}ajf-form-builder mat-toolbar .ajf-spacer{flex:1 1 auto}"],changeDetection:o.ChangeDetectionStrategy.OnPush,encapsulation:o.ViewEncapsulation.None}]}],li.ctorParameters=function(){return[{type:K},{type:d.MatDialog}]},li.propDecorators={designerCont:[{type:o.ViewChild,args:["designer",{static:!0}]}],form:[{type:o.Input}]},li);function li(i,e){var t=this;this._service=i,this._dialog=e,this._vc=new o.EventEmitter,this._init=!1,this._editConditionSub=O.Subscription.EMPTY,this._beforeNodesUpdateSub=O.Subscription.EMPTY,this._editChoicesOriginSub=O.Subscription.EMPTY,this._stringIdentifierSub=O.Subscription.EMPTY,this._nodeTypes=i.availableNodeTypes,this._nodeEntriesTree=i.nodeEntriesTree,this._choicesOrigins=i.choicesOrigins,this._editConditionSub=this._service.editedCondition.subscribe(function(i){null!=t._editConditionDialog&&(t._editConditionDialog.close(),t._editConditionDialog=null),null!=i&&(t._editConditionDialog=t._dialog.open(ni,{disableClose:!0}))}),this._editChoicesOriginSub=this._service.editedChoicesOrigin.subscribe(function(i){null!=t._editChoicesOriginDialog&&(t._editChoicesOriginDialog.close(),t._editChoicesOriginDialog=null),null!=i&&(t._editChoicesOriginDialog=t._dialog.open(X,{disableClose:!0}))}),this._beforeNodesUpdateSub=this._service.beforeNodesUpdate.subscribe(function(){null!=t.designerCont&&(t._lastScrollTop=t.designerCont.nativeElement.scrollTop)}),this.nodeEntriesTree.pipe(x.sample(this._vc)).subscribe(function(){null!=t.designerCont&&(t.designerCont.nativeElement.scrollTop=t._lastScrollTop)}),this._stringIdentifierSub=this._service.stringIdentifier.subscribe(function(){})}var di=["#F44336","#4CAF50","#3F51B5","#FFC107","#795548"],ci=(Object.defineProperty(ui.prototype,"hasContent",{get:function(){return this._hasContent},enumerable:!0,configurable:!0}),Object.defineProperty(ui.prototype,"isFirst",{get:function(){return this._isFirst},set:function(i){this._isFirst=i},enumerable:!0,configurable:!0}),Object.defineProperty(ui.prototype,"isNodeEntry",{get:function(){return this._isNodeEntry},enumerable:!0,configurable:!0}),Object.defineProperty(ui.prototype,"nodeEntry",{get:function(){return this._nodeEntry},set:function(i){if(null!=(this._nodeEntry=i)&&void 0!==i.node){var e=i;this._isNodeEntry=!0;var t=e.node;this._hasContent=null!=t&&F.isContainerNode(t)}else this._isNodeEntry=!1,this._hasContent=!1},enumerable:!0,configurable:!0}),Object.defineProperty(ui.prototype,"level",{get:function(){return this._level},set:function(i){this._level=i},enumerable:!0,configurable:!0}),Object.defineProperty(ui.prototype,"realNodeEntry",{get:function(){return this._nodeEntry},enumerable:!0,configurable:!0}),Object.defineProperty(ui.prototype,"branchColors",{get:function(){return this._branchColors},enumerable:!0,configurable:!0}),Object.defineProperty(ui.prototype,"dropZones",{get:function(){return this._dropZones},enumerable:!0,configurable:!0}),Object.defineProperty(ui.prototype,"slideDropZones",{get:function(){return this._slideDropZones},enumerable:!0,configurable:!0}),Object.defineProperty(ui.prototype,"originOffset",{get:function(){return this._originOffset},set:function(i){this._originOffset=i,this._originLeftMargin=4*this._originOffset+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(ui.prototype,"originLeftMargin",{get:function(){return this._originLeftMargin},enumerable:!0,configurable:!0}),Object.defineProperty(ui.prototype,"firstBranchColor",{get:function(){return this._firstBranchColor},set:function(i){var e=di.indexOf(i);0<e?(this._firstBranchColor=i,this._branchColors=di.slice(e).concat(di.slice(0,e))):(this._firstBranchColor=di[0],this._branchColors=di.slice(0))},enumerable:!0,configurable:!0}),Object.defineProperty(ui.prototype,"currentEditedNode",{get:function(){return this._currentEditedNode},enumerable:!0,configurable:!0}),ui.prototype.onResize=function(){},ui.prototype.edit=function(){null!=this.nodeEntry&&this.isNodeEntry&&this._service.editNodeEntry(this.nodeEntry)},ui.prototype.delete=function(){null!=this.nodeEntry&&this.isNodeEntry&&this._service.deleteNodeEntry(this.nodeEntry)},ui.prototype.ngAfterViewInit=function(){var i=this;setTimeout(function(){return i._updateBranchHeights()}),this._childEntriesSubscription=this.childEntries.changes.subscribe(function(){i._updateBranchHeights()})},ui.prototype.ngOnDestroy=function(){this._branchLinesSubscription.unsubscribe(),this._childEntriesSubscription.unsubscribe()},ui.prototype.onDropSuccess=function(i,e){if(void 0===e&&(e=!1),null!=this._nodeEntry){var t=i.item.data;if(void 0!==t.nodeType&&(!this.isNodeEntry||this.isNodeEntry&&e)){var n=e?{parent:this.nodeEntry.node,parentNode:0}:this._nodeEntry;this._service.insertNode(t,n.parent,n.parentNode,e)}}},ui.prototype.disableSlideDropPredicate=function(i){return!i.data.isSlide},ui.prototype.emptyAreaDropPredicate=function(){var t=this;return function(i,e){return 0<t._level?!i.data.isSlide:i.data.isSlide||!1}},ui.prototype._updateBranchHeights=function(){if(null!=this.nodeEntry&&this.isNodeEntry&&null!=this.branchLines&&null!=this.childEntries){var i=this.nodeEntry,e=this.branchLines.toArray(),t=null!=i.content?i.content.length:0,n=this.childEntries.toArray().slice(t);e.length==n.length&&e.forEach(function(i,e){var t=n[e];i.height=t.nativeElement.offsetTop})}},ui.decorators=[{type:o.Component,args:[{selector:"ajf-fb-node-entry",template:'<ng-template [ngIf]="nodeEntry != null"><ng-template [ngIf]="isNodeEntry"><ajf-fb-branch-line *ngFor="let childNodeEntry of realNodeEntry.children; let idx = index" [offset]="idx" [color]="branchColors[idx]"></ajf-fb-branch-line></ng-template><div class="mat-card-container" [class.ajf-highlight]="(currentEditedNode|async) == nodeEntry"><div *ngIf="!isFirst" class="ajf-origin-line" [style.margin-left]="originLeftMargin" [style.border-color]="firstBranchColor"></div><ng-template [ngIf]="isNodeEntry"><mat-card><div class="ajf-title-row"><ajf-node-icon [node]="realNodeEntry.node"></ajf-node-icon><span class="ajf-title" [innerHTML]="(realNodeEntry.node.label || realNodeEntry.node.name)  | translate"></span> <span class="ajf-actions"><button [disabled]="currentEditedNode|async" (click)="edit()" mat-icon-button><mat-icon>edit</mat-icon></button> <button [disabled]="currentEditedNode|async" (click)="delete()" mat-icon-button><mat-icon>delete</mat-icon></button></span></div><div *ngIf="hasContent"><ajf-fb-node-entry *ngFor="let contentEntry of realNodeEntry.content; let isFirstChild = first; let idx = index" [level]="level + 1" [isFirst]="isFirstChild" [firstBranchColor]="branchColors[idx]" [nodeEntry]="contentEntry"></ajf-fb-node-entry><mat-card class="ajf-empty" *ngIf="realNodeEntry.content.length === 0" cdkDropList [cdkDropListEnterPredicate]="disableSlideDropPredicate" (cdkDropListDropped)="onDropSuccess($event, true)">&nbsp;</mat-card></div></mat-card></ng-template><ng-template [ngIf]="!isNodeEntry"><mat-card class="ajf-empty" cdkDropList [cdkDropListEnterPredicate]="emptyAreaDropPredicate()" (cdkDropListDropped)="onDropSuccess($event)">&nbsp;</mat-card></ng-template></div><ng-template [ngIf]="isNodeEntry"><ajf-fb-node-entry *ngFor="let childNodeEntry of realNodeEntry.children; let idx = index" [level]="level" [originOffset]="idx" [firstBranchColor]="branchColors[idx]" [nodeEntry]="childNodeEntry"></ajf-fb-node-entry></ng-template></ng-template>',styles:["ajf-fb-node-entry{display:block;position:relative}ajf-fb-node-entry .mat-card-container{position:relative}ajf-fb-node-entry .mat-card-container .ajf-origin-line{position:absolute;top:0;left:25px;width:25px;height:25px;border-bottom:2px solid;border-left:2px solid;border-bottom-left-radius:.5em}ajf-fb-node-entry .mat-card-container mat-card{margin-left:50px;padding:.5em 1em;margin-top:.2em;margin-bottom:.2em;background-color:#fff}ajf-fb-node-entry .mat-card-container mat-card .ajf-title-row{display:flex;flex-direction:row;align-items:center}ajf-fb-node-entry .mat-card-container mat-card .ajf-title-row>.ajf-title{flex:1 1 auto}ajf-fb-node-entry .mat-card-container mat-card .ajf-title-row>.ajf-actions{flex:0 0 auto;white-space:nowrap}ajf-fb-node-entry .mat-card-container mat-card.ajf-empty{line-height:36px;border:2px dashed;box-shadow:none;box-sizing:border-box}ajf-fb-node-entry .mat-card-container.ajf-highlight>mat-card{background-color:#fff9c4}"],host:{"(window.resize)":"onResize()"},encapsulation:o.ViewEncapsulation.None,changeDetection:o.ChangeDetectionStrategy.OnPush}]}],ui.ctorParameters=function(){return[{type:K}]},ui.propDecorators={branchLines:[{type:o.ViewChildren,args:[P]}],childEntries:[{type:o.ViewChildren,args:[ui,{read:o.ElementRef}]}],isFirst:[{type:o.Input}],nodeEntry:[{type:o.Input}],level:[{type:o.Input}],originOffset:[{type:o.Input}],firstBranchColor:[{type:o.Input}]},ui);function ui(i){this._service=i,this._hasContent=!1,this._isFirst=!1,this._isNodeEntry=!1,this._level=0,this._branchColors=di.slice(0),this._dropZones=["fbdz-node"],this._slideDropZones=["fbdz-slide"],this._originOffset=0,this._originLeftMargin="0",this._firstBranchColor=di[0],this._branchLinesSubscription=O.Subscription.EMPTY,this._childEntriesSubscription=O.Subscription.EMPTY,this._currentEditedNode=this._service.editedNodeEntry}var pi=(Object.defineProperty(fi.prototype,"fields",{get:function(){return this._fields},enumerable:!0,configurable:!0}),fi.prototype.saveCondition=function(){if(null!=this.editor){var i=this.editor.editedValue;this.dialogRef.close({condition:i,errorMessage:this.errorMessage})}},fi.decorators=[{type:o.Component,args:[{selector:"ajf-fb-validation-condition-editor-dialog",template:'<h3 matDialogTitle translate>Edit condition</h3><mat-dialog-content><mat-form-field><input matInput [(ngModel)]="errorMessage" [placeholder]="\'Error message\' | translate"></mat-form-field><ajf-condition-editor [fields]="fields|async" [condition]="condition"></ajf-condition-editor></mat-dialog-content><mat-dialog-actions><button mat-button translate (click)="saveCondition()">Save</button> <button mat-button translate matDialogClose>Close</button></mat-dialog-actions>',styles:["ajf-fb-validation-condition-editor-dialog mat-dialog-content{overflow:visible}"],encapsulation:o.ViewEncapsulation.None,changeDetection:o.ChangeDetectionStrategy.OnPush}]}],fi.ctorParameters=function(){return[{type:K},{type:d.MatDialogRef}]},fi.propDecorators={editor:[{type:o.ViewChild,args:[ei,{static:!0}]}]},fi);function fi(i,e){this.dialogRef=e,this._fields=i.flatFields.pipe(x.map(function(i){return i.sort(function(i,e){return i.name.localeCompare(e.name)})}))}var hi=(Object.defineProperty(mi.prototype,"fields",{get:function(){return this._fields},enumerable:!0,configurable:!0}),mi.prototype.saveCondition=function(){if(null!=this.editor){var i=this.editor.editedValue;this.dialogRef.close({condition:i,warningMessage:this.warningMessage})}},mi.decorators=[{type:o.Component,args:[{selector:"ajf-fb-warning-condition-editor-dialog",template:'<h3 matDialogTitle translate>Edit condition</h3><mat-dialog-content><mat-form-field><input matInput [(ngModel)]="warningMessage" [placeholder]="\'Warning message\' | translate"></mat-form-field><ajf-condition-editor [fields]="fields|async" [condition]="condition"></ajf-condition-editor></mat-dialog-content><mat-dialog-actions><button mat-button translate (click)="saveCondition()">Save</button> <button mat-button translate matDialogClose>Close</button></mat-dialog-actions>',styles:["ajf-fb-warning-condition-editor-dialog mat-dialog-content{overflow:visible}"],encapsulation:o.ViewEncapsulation.None,changeDetection:o.ChangeDetectionStrategy.OnPush}]}],mi.ctorParameters=function(){return[{type:K},{type:d.MatDialogRef}]},mi.propDecorators={editor:[{type:o.ViewChild,args:[ei,{static:!0}]}]},mi);function mi(i,e){this.dialogRef=e,this._fields=i.flatFields.pipe(x.map(function(i){return i.sort(function(i,e){return i.name.localeCompare(e.name)})}))}function gi(i){var e=i.value.minReps,t=i.value.maxReps;return null!=e&&null!=t&&t<e?{reps:"Min repetions cannot be greater than max repetitions"}:null}function bi(i){var e=i.value.minValue,t=i.value.maxValue;return null!=e&&null!=t&&t<e?{valueLimit:"Min value cannot be greater than max value"}:null}function vi(i){var e=i.value.minDigits,t=i.value.maxDigits;return null!=e&&null!=t&&t<e?{digits:"Min digits cannot be greater than max digits"}:null}var _i=(Object.defineProperty(yi.prototype,"fieldSizes",{get:function(){return this._fieldSizes},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"nodeEntry",{get:function(){return this._nodeEntry},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"choicesOrigins",{get:function(){return this._choicesOrigins},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"enabled",{get:function(){return this._enabled},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"propertiesForm",{get:function(){return this._propertiesForm},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"hasChoices",{get:function(){return this._hasChoices},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"curVisibility",{get:function(){return this._curVisibility},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"curFormulaReps",{get:function(){return this._curFormulaReps},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"curChoicesFilter",{get:function(){return this._curChoicesFilter},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"curForceValue",{get:function(){return this._curForceValue},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"curFormula",{get:function(){return this._curFormula},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"conditionalBranches",{get:function(){return this._conditionalBranches},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"validationConditions",{get:function(){return this._validationConditions},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"warningConditions",{get:function(){return this._warningConditions},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"nextSlideCondition",{get:function(){return this._nextSlideCondition},enumerable:!0,configurable:!0}),Object.defineProperty(yi.prototype,"triggerConditions",{get:function(){return this._triggerConditions},enumerable:!0,configurable:!0}),yi.prototype.editVisibility=function(){this._editVisibilityEvt.emit()},yi.prototype.editConditionalBranch=function(i){i<0||i>=this._conditionalBranches.length||this._editConditionalBranchEvt.emit(i)},yi.prototype.editFormulaReps=function(){this._editFormulaRepsEvt.emit()},yi.prototype.editChoicesFilter=function(){this._editChoicesFilterEvt.emit()},yi.prototype.editFormula=function(){this._editFormulaEvt.emit()},yi.prototype.editForceValue=function(){this._editForceValueEvt.emit()},yi.prototype.editValidationCondition=function(i){i<0||i>=this._validationConditions.length||this._editValidationConditionEvt.emit(i)},yi.prototype.addValidationCondition=function(){this._addValidationConditionEvt.emit()},yi.prototype.removeValidationCondition=function(i){i<0||i>=this._validationConditions.length||this._removeValidationConditionEvt.emit(i)},yi.prototype.editWarningCondition=function(i){i<0||i>=this._warningConditions.length||this._editWarningConditionEvt.emit(i)},yi.prototype.addWarningCondition=function(){this._addWarningConditionEvt.emit()},yi.prototype.removeWarningCondition=function(i){i<0||i>=this._warningConditions.length||this._removeWarningConditionEvt.emit(i)},yi.prototype.editNextSlideCondition=function(){this._editNextSlideConditionEvt.emit()},yi.prototype.editTriggerCondition=function(i){i<0||i>=this._triggerConditions.length||this._editTriggerConditionEvt.emit(i)},yi.prototype.addTriggerCondition=function(){this._addTriggerConditionEvt.emit()},yi.prototype.removeTriggerCondition=function(i){i<0||i>=this._triggerConditions.length||this._removeTriggerConditionEvt.emit(i)},yi.prototype.isField=function(i){return F.isField(i)},yi.prototype.isNumericField=function(i){return F.isField(i)&&F.isNumberField(i)},yi.prototype.isFieldWithChoices=function(i){return F.isField(i)&&F.isFieldWithChoices(i)},yi.prototype.save=function(){this._saveEvt.emit()},yi.prototype.cancel=function(){this._service.cancelNodeEntryEdit()},yi.prototype.ngOnDestroy=function(){this._choicesOriginsSub.unsubscribe(),this._visibilitySub.unsubscribe(),this._formulaRepsSub.unsubscribe(),this._choicesFilterSub.unsubscribe(),this._formulaSub.unsubscribe(),this._forceValueSub.unsubscribe(),this._validationConditionsSub.unsubscribe(),this._warningConditionsSub.unsubscribe(),this._triggerConditionsSub.unsubscribe(),this._editConditionDialogSub.unsubscribe(),this._editValidationConditionDialogSub.unsubscribe(),this._editWarningConditionDialogSub.unsubscribe(),this._editChoicesFilterSub.unsubscribe(),this._editConditionalBranchSub.unsubscribe(),this._editVisibilitySub.unsubscribe(),this._editFormulaRepsSub.unsubscribe(),this._editFormulaSub.unsubscribe(),this._editForceValueSub.unsubscribe(),this._editValidationConditionSub.unsubscribe(),this._editWarningConditionSub.unsubscribe(),this._nextSlideConditionSub.unsubscribe(),this._addTriggerConditionSub.unsubscribe(),this._addValidationConditionSub.unsubscribe(),this._addWarningConditionSub.unsubscribe(),this._editNextSlideConditionSub.unsubscribe(),this._editTriggerConditionSub.unsubscribe(),this._removeTriggerConditionSub.unsubscribe(),this._removeValidationConditionSub.unsubscribe(),this._removeWarningConditionSub.unsubscribe(),this._saveSub.unsubscribe()},yi.prototype._initSave=function(){var n=this;this._saveSub=this._saveEvt.pipe(x.withLatestFrom(this.propertiesForm)).subscribe(function(i){var e=i[1],t=M({},e.value,{conditionalBranches:n._conditionalBranches});n._service.saveNodeEntry(t)})},yi.prototype._initForm=function(){var S=this;this._propertiesForm=this._nodeEntry.pipe(x.filter(function(i){return null!=i}),x.map(function(i){null!=S._visibilitySub&&S._visibilitySub.unsubscribe(),null!=S._conditionalBranchesSub&&S._conditionalBranchesSub.unsubscribe();var e=null!=(i=i).node.visibility?i.node.visibility.condition:null,t=null!=i.node.visibility?S._guessVisibilityOpt(i.node.visibility):null,n={name:[i.node.name,j.Validators.required],label:i.node.label,visibilityOpt:[t,j.Validators.required],visibility:[e,j.Validators.required],conditionalBranchesNum:i.node.conditionalBranches.length},o=[];if(F.isRepeatingContainerNode(i.node)){var a=i.node,r=null!=a.formulaReps?a.formulaReps.formula:null;n.formulaReps=[r,j.Validators.required],n.minReps=a.minReps,n.maxReps=a.maxReps,S._curFormulaReps=r,o.push(gi)}if(S.isField(i.node)){var s=i.node,l=null,d=!1,c=[];null!=s.validation&&(null!=s.validation.forceValue&&(l=s.validation.forceValue.condition),d=null!=s.validation.notEmpty,c=(s.validation.conditions||[]).map(function(i){return{condition:i.condition,errorMessage:i.errorMessage}}));var u=!1,p=[];null!=s.warning&&(u=null!=s.warning.notEmpty,p=(s.warning.conditions||[]).map(function(i){return{condition:i.condition,warningMessage:i.warningMessage}}));var f=null!=s.formula?s.formula.formula:null;n.description=s.description,n.defaultValue=s.defaultValue,n.size=s.size,n.formula=f,n.forceValue=l,n.notEmpty=d,n.validationConditions=[c,[]],n.notEmptyWarning=u,n.warningConditions=[p,[]],n.nextSlideCondition=[s.nextSlideCondition],S._curForceValue=l,S._curFormula=f,S._validationConditions=c,S._warningConditions=p}if(S.isNumericField(i.node)){var h=i.node,m=void 0,g=void 0,b=void 0,v=void 0;null!=h.validation&&(null!=h.validation.minValue&&(m=(h.validation.minValue.condition||"").replace("$value >= ","")),null!=h.validation.maxValue&&(g=(h.validation.maxValue.condition||"").replace("$value <= ","")),null!=h.validation.minDigits&&(b=(h.validation.minDigits.condition||"").replace("$value.toString().length >= ","")),null!=h.validation.maxDigits&&(v=(h.validation.maxDigits.condition||"").replace("$value.toString().length <= ",""))),n.minValue=m,n.maxValue=g,n.minDigits=b,n.maxDigits=v,o.push(bi),o.push(vi)}if(S.isFieldWithChoices(i.node)){var _=i.node,y=(_.triggerConditions||[]).map(function(i){return i.condition});n.choicesOrigin=_.choicesOrigin.name,n.choicesFilter=null!=_.choicesFilter?_.choicesFilter.formula:null,n.forceExpanded=_.forceExpanded,n.forceNarrow=_.forceNarrow,n.triggerConditions=y,S._triggerConditions=y}var C=S._fb.group(n);return C.setValidators(o),S._conditionalBranches=i.node.conditionalBranches.map(function(i){return i.condition}),S._curVisibility=null!=i.node.visibility?i.node.visibility.condition:null,S._handleConditionalBranchesChange(C),S._handleVisibilityChange(C),S._handleFormulaRepsChange(C),S._handleChoicesFilterChange(C),S._handleFormulaChange(C),S._handleForceValueChange(C),S._handleValidationCondtionsChange(C),S._handleWarningCondtionsChange(C),S._handleNextSlideConditionChange(C),S._handleTriggerCondtionsChange(C),C}),x.publishReplay(1),x.refCount())},yi.prototype._destroyConditionDialog=function(){null!=this._editConditionDialogSub&&(this._editConditionDialogSub.unsubscribe(),this._editConditionDialogSub=O.Subscription.EMPTY),null!=this._editConditionDialog&&(this._editConditionDialog.close(),this._editConditionDialog=null)},yi.prototype._destroyValidationConditionDialog=function(){null!=this._editValidationConditionDialogSub&&(this._editValidationConditionDialogSub.unsubscribe(),this._editValidationConditionDialogSub=O.Subscription.EMPTY),null!=this._editValidationConditionDialog&&(this._editValidationConditionDialog.close(),this._editValidationConditionDialog=null)},yi.prototype._destroyWarningConditionDialog=function(){null!=this._editWarningConditionDialogSub&&(this._editWarningConditionDialogSub.unsubscribe(),this._editWarningConditionDialogSub=O.Subscription.EMPTY),null!=this._editWarningConditionDialog&&(this._editWarningConditionDialog.close(),this._editWarningConditionDialog=null)},yi.prototype._initRemoveTriggerCondition=function(){this._removeTriggerConditionSub=this._removeTriggerConditionEvt.pipe(x.withLatestFrom(this._propertiesForm)).subscribe(function(i){var e=i[0],t=i[1];if(null!=t){var n=t.controls.triggerConditions,o=(n.value||[]).slice(0);e<0||e>=o.length||(o.splice(e,1),n.setValue(o))}})},yi.prototype._initAddTriggerCondition=function(){this._addTriggerConditionSub=this._addTriggerConditionEvt.pipe(x.withLatestFrom(this._propertiesForm)).subscribe(function(i){var e=i[1];if(null!=e){var t=e.controls.triggerConditions,n=(t.value||[]).slice(0);n.push(""),t.setValue(n)}})},yi.prototype._initTriggerConditionEdit=function(){var n=this;this._editTriggerConditionSub=this._editTriggerConditionEvt.pipe(x.withLatestFrom(this._propertiesForm)).subscribe(function(i){n._destroyConditionDialog();var e=i[0],t=i[1];e<0||e>=n._triggerConditions.length||null==t||(n._editConditionDialog=n._dialog.open(ni),n._editConditionDialog.componentInstance.condition=n._triggerConditions[e],n._editConditionDialogSub=n._editConditionDialog.afterClosed().subscribe(function(i){void 0!==i&&(n._triggerConditions[e]=i),n._editConditionDialogSub.unsubscribe(),n._editConditionDialogSub=O.Subscription.EMPTY}))})},yi.prototype._initRemoveWarningCondition=function(){this._removeWarningConditionSub=this._removeWarningConditionEvt.pipe(x.withLatestFrom(this._propertiesForm)).subscribe(function(i){var e=i[0],t=i[1];if(null!=t){var n=t.controls.warningConditions,o=(n.value||[]).slice(0);e<0||e>=o.length||(o.splice(e,1),n.setValue(o))}})},yi.prototype._initAddWarningCondition=function(){this._addWarningConditionSub=this._addWarningConditionEvt.pipe(x.withLatestFrom(this._propertiesForm)).subscribe(function(i){var e=i[1];if(null!=e){var t=e.controls.warningConditions,n=(t.value||[]).slice(0);n.push({condition:"",errorMessage:""}),t.setValue(n)}})},yi.prototype._initWarningConditionEdit=function(){var a=this;this._editWarningConditionSub=this._editWarningConditionEvt.pipe(x.withLatestFrom(this._propertiesForm)).subscribe(function(i){a._destroyWarningConditionDialog();var e=i[0],t=i[1];if(!(e<0||e>=a._warningConditions.length||null==t)){a._editWarningConditionDialog=a._dialog.open(hi);var n=a._editWarningConditionDialog.componentInstance,o=a._warningConditions[e];n.condition=o.condition,n.warningMessage=o.warningMessage,a._editWarningConditionDialogSub=a._editWarningConditionDialog.afterClosed().subscribe(function(i){void 0!==i&&(a._warningConditions[e]=i),a._editWarningConditionDialogSub.unsubscribe(),a._editWarningConditionDialogSub=O.Subscription.EMPTY})}})},yi.prototype._initRemoveValidationCondition=function(){this._removeValidationConditionSub=this._removeValidationConditionEvt.pipe(x.withLatestFrom(this._propertiesForm)).subscribe(function(i){var e=i[0],t=i[1];if(null!=t){var n=t.controls.validationConditions,o=(n.value||[]).slice(0);e<0||e>=o.length||(o.splice(e,1),n.setValue(o))}})},yi.prototype._initAddValidationCondition=function(){this._addValidationConditionSub=this._addValidationConditionEvt.pipe(x.withLatestFrom(this._propertiesForm)).subscribe(function(i){var e=i[1];if(null!=e){var t=e.controls.validationConditions,n=(t.value||[]).slice(0);n.push({condition:"",errorMessage:""}),t.setValue(n)}})},yi.prototype._initValidationConditionEdit=function(){var a=this;this._editValidationConditionSub=this._editValidationConditionEvt.pipe(x.withLatestFrom(this._propertiesForm)).subscribe(function(i){a._destroyValidationConditionDialog();var e=i[0],t=i[1];if(!(e<0||e>=a._validationConditions.length||null==t)){a._editValidationConditionDialog=a._dialog.open(pi);var n=a._editValidationConditionDialog.componentInstance,o=a._validationConditions[e];n.condition=o.condition,n.errorMessage=o.errorMessage,a._editValidationConditionDialogSub=a._editValidationConditionDialog.afterClosed().subscribe(function(i){void 0!==i&&(a._validationConditions[e]=i),a._editValidationConditionDialogSub.unsubscribe(),a._editValidationConditionDialogSub=O.Subscription.EMPTY})}})},yi.prototype._initForceValueEdit=function(){var n=this;this._editForceValueSub=this._editForceValueEvt.pipe(x.withLatestFrom(this._propertiesForm)).subscribe(function(i){n._destroyConditionDialog();var e=i[1];if(null!=e){var t=e.controls.forceValue;n._editConditionDialog=n._dialog.open(ni),n._editConditionDialog.componentInstance.condition=t.value,n._editConditionDialogSub=n._editConditionDialog.afterClosed().subscribe(function(i){void 0!==i&&t.setValue(i),n._editConditionDialogSub.unsubscribe(),n._editConditionDialogSub=O.Subscription.EMPTY})}})},yi.prototype._initNextSlideConditionEdit=function(){var n=this;this._editNextSlideConditionSub=this._editNextSlideConditionEvt.pipe(x.withLatestFrom(this._propertiesForm)).subscribe(function(i){n._destroyConditionDialog();var e=i[1];if(null!=e){var t=e.controls.nextSlideCondition;n._editConditionDialog=n._dialog.open(ni),n._editConditionDialog.componentInstance.condition=t.value,n._editConditionDialogSub=n._editConditionDialog.afterClosed().subscribe(function(i){void 0!==i&&t.setValue(i),n._editConditionDialogSub.unsubscribe(),n._editConditionDialogSub=O.Subscription.EMPTY})}})},yi.prototype._initFormulaEdit=function(){var n=this;this._editFormulaSub=this._editFormulaEvt.pipe(x.withLatestFrom(this._propertiesForm)).subscribe(function(i){n._destroyConditionDialog();var e=i[1];if(null!=e){var t=e.controls.formula;n._editConditionDialog=n._dialog.open(ni),n._editConditionDialog.componentInstance.condition=t.value,n._editConditionDialogSub=n._editConditionDialog.afterClosed().subscribe(function(i){void 0!==i&&t.setValue(i),n._editConditionDialogSub.unsubscribe(),n._editConditionDialogSub=O.Subscription.EMPTY})}})},yi.prototype._initFormulaRepsEdit=function(){var n=this;this._editFormulaRepsSub=this._editFormulaRepsEvt.pipe(x.withLatestFrom(this._propertiesForm)).subscribe(function(i){n._destroyConditionDialog();var e=i[1];if(null!=e){var t=e.controls.formulaReps;n._editConditionDialog=n._dialog.open(ni),n._editConditionDialog.componentInstance.condition=t.value,n._editConditionDialogSub=n._editConditionDialog.afterClosed().subscribe(function(i){void 0!==i&&t.setValue(i),n._editConditionDialogSub.unsubscribe(),n._editConditionDialogSub=O.Subscription.EMPTY})}})},yi.prototype._initChoicesFilterEdit=function(){var n=this;this._editChoicesFilterSub=this._editChoicesFilterEvt.pipe(x.withLatestFrom(this._propertiesForm)).subscribe(function(i){n._destroyConditionDialog();var e=i[1];if(null!=e){var t=e.controls.choicesFilter;n._editConditionDialog=n._dialog.open(ni),n._editConditionDialog.componentInstance.condition=t.value,n._editConditionDialogSub=n._editConditionDialog.afterClosed().subscribe(function(i){void 0!==i&&t.setValue(i),n._editConditionDialogSub.unsubscribe(),n._editConditionDialogSub=O.Subscription.EMPTY})}})},yi.prototype._initConditionalBranchEdit=function(){var n=this;this._editConditionalBranchSub=this._editConditionalBranchEvt.pipe(x.withLatestFrom(this._propertiesForm)).subscribe(function(i){n._destroyConditionDialog();var e=i[0],t=i[1];e<0||e>=n._conditionalBranches.length||null==t||(n._editConditionDialog=n._dialog.open(ni),n._editConditionDialog.componentInstance.condition=n._conditionalBranches[e],n._editConditionDialogSub=n._editConditionDialog.afterClosed().subscribe(function(i){void 0!==i&&(n._conditionalBranches[e]=i),n._editConditionDialogSub.unsubscribe(),n._editConditionDialogSub=O.Subscription.EMPTY}))})},yi.prototype._initVisibilityEdit=function(){var o=this;this._editVisibilitySub=this._editVisibilityEvt.pipe(x.withLatestFrom(this._propertiesForm)).subscribe(function(i){o._destroyConditionDialog();var e=i[1];if(null!=e){var t=e.controls.visibility,n=t.value;o._editConditionDialog=o._dialog.open(ni),o._editConditionDialog.componentInstance.condition=n,o._editConditionDialogSub=o._editConditionDialog.afterClosed().subscribe(function(i){void 0!==i&&t.setValue(i),o._editConditionDialogSub.unsubscribe(),o._editConditionDialogSub=O.Subscription.EMPTY})}})},yi.prototype._handleTriggerCondtionsChange=function(i){var e=this;this._triggerConditionsSub=i.valueChanges.pipe(x.distinctUntilChanged(function(i,e){return JSON.stringify(i.triggerConditions)===JSON.stringify(e.triggerConditions)})).subscribe(function(i){e._triggerConditions=i.triggerConditions})},yi.prototype._handleWarningCondtionsChange=function(i){var e=this;this._warningConditionsSub=i.valueChanges.pipe(x.distinctUntilChanged(function(i,e){return JSON.stringify(i.warningConditions)===JSON.stringify(e.warningConditions)})).subscribe(function(i){e._warningConditions=i.warningConditions})},yi.prototype._handleValidationCondtionsChange=function(i){var e=this;this._validationConditionsSub=i.valueChanges.pipe(x.distinctUntilChanged(function(i,e){return JSON.stringify(i.validationConditions)===JSON.stringify(e.validationConditions)})).subscribe(function(i){e._validationConditions=i.validationConditions})},yi.prototype._handleForceValueChange=function(i){var e=this;this._forceValueSub=i.valueChanges.pipe(x.distinctUntilChanged(function(i,e){return i.forceValue===e.forceValue})).subscribe(function(i){e._curForceValue=i.forceValue})},yi.prototype._handleNextSlideConditionChange=function(i){var e=this;this._formulaSub=i.valueChanges.pipe(x.distinctUntilChanged(function(i,e){return i.nextSlideCondition===e.nextSlideCondition})).subscribe(function(i){e._nextSlideCondition=i.nextSlideCondition})},yi.prototype._handleFormulaChange=function(i){var e=this;this._formulaSub=i.valueChanges.pipe(x.distinctUntilChanged(function(i,e){return i.formula===e.formula})).subscribe(function(i){e._curFormula=i.formula})},yi.prototype._handleFormulaRepsChange=function(i){var e=this;this._formulaRepsSub=i.valueChanges.pipe(x.distinctUntilChanged(function(i,e){return i.formulaReps===e.formulaReps})).subscribe(function(i){e._curFormulaReps=i.formulaReps})},yi.prototype._handleChoicesFilterChange=function(i){var e=this;this._choicesFilterSub=i.valueChanges.pipe(x.distinctUntilChanged(function(i,e){return i.choicesFilter===e.choicesFilter})).subscribe(function(i){e._curChoicesFilter=i.choicesFilter})},yi.prototype._handleConditionalBranchesChange=function(i){var a=this;this._conditionalBranchesSub=i.valueChanges.pipe(x.distinctUntilChanged(function(i,e){return i.conditionalBranchesNum===e.conditionalBranchesNum})).subscribe(function(i){var e=i.conditionalBranchesNum,t=a._conditionalBranches.length;if(t<e){for(var n=[],o=t;o<e;o++)n.push(w.alwaysCondition().condition);a._conditionalBranches=a._conditionalBranches.concat(n)}else e<t&&a._conditionalBranches.splice(0,t-e)})},yi.prototype._handleVisibilityChange=function(t){var n=this;this._visibilitySub=t.valueChanges.pipe(x.distinctUntilChanged(function(i,e){return i.visibilityOpt===e.visibilityOpt})).subscribe(function(i){var e;switch(i.visibilityOpt){case"always":e=w.alwaysCondition().condition;break;case"never":e=w.neverCondition().condition;break;default:e=null}n._curVisibility=e,t.controls.visibility.setValue(e)})},yi.prototype._guessVisibilityOpt=function(i){return 0===i.condition.localeCompare(w.alwaysCondition().condition)?"always":0===i.condition.localeCompare(w.neverCondition().condition)?"never":"condition"},yi.decorators=[{type:o.Component,args:[{selector:"ajf-fb-node-properties",template:'<div [style.display]="(enabled|async) ? \'none\' : \'block\'" class="ajf-disabled-overlay"></div><div class="ajf-header"><h3 translate>Properties</h3><mat-icon (click)="save()">save</mat-icon><mat-icon (click)="cancel()">cancel</mat-icon></div><ng-container *ngIf="nodeEntry|async as ne"><ng-container *ngIf="propertiesForm|async as pf"><form [formGroup]="pf" novalidate><div class="ajf-prop"><mat-form-field><input matInput formControlName="name" [placeholder]="\'Name\' | translate"></mat-form-field></div><div class="ajf-prop"><mat-form-field><input matInput formControlName="label" [placeholder]="\'Label\' | translate"></mat-form-field></div><div class="ajf-prop"><mat-form-field><mat-label translate>Visibility</mat-label><mat-select formControlName="visibilityOpt" [placeholder]="\'Visible\' | translate"><mat-option value="always" translate>Always</mat-option><mat-option value="never" translate>Never</mat-option><mat-option value="condition" translate>Condition...</mat-option></mat-select></mat-form-field><button (click)="editVisibility()" [disabled]="pf.value[\'visibilityOpt\'] != \'condition\'" mat-raised-button [matTooltip]="curVisibility"><div class="ajf-icon-cont"><mat-icon>edit</mat-icon><span>{{ curVisibility }}</span></div></button></div><div class="ajf-prop"><div><label translate>Branches</label></div><div><mat-slider formControlName="conditionalBranchesNum" thumbLabel tickInterval="auto" min="1" max="5" step="1"></mat-slider></div><div *ngFor="let branch of conditionalBranches; let idx = index"><button (click)="editConditionalBranch(idx)" mat-raised-button [matTooltip]="branch"><div class="ajf-icon-cont"><mat-icon>edit</mat-icon><span>{{ branch }}</span></div></button></div></div><ng-template [ngIf]="isRepeatingContainerNode((ne)?.node)"><div class="ajf-prop"><div><label translate>Repetitions</label></div><div><button (click)="editFormulaReps()" mat-raised-button [matTooltip]="curFormulaReps"><div class="ajf-icon-cont"><mat-icon>edit</mat-icon><span>{{ curFormulaReps }}</span></div></button></div><div><label translate>Min repetitions</label></div><div><mat-slider formControlName="minReps" thumbLabel tickInterval="auto" min="1" max="5" step="1"></mat-slider></div><div><label translate>Max repetitions</label></div><div><mat-slider formControlName="maxReps" thumbLabel tickInterval="auto" min="1" max="5" step="1"></mat-slider></div></div></ng-template><ng-template [ngIf]="isField((ne)?.node)"><div class="ajf-prop"><mat-form-field><mat-label translate>Field size</mat-label><mat-select formControlName="size" [placeholder]="\'Size\' | translate"><mat-option *ngFor="let fieldSize of fieldSizes" [value]="fieldSize.value">{{ fieldSize.label }}</mat-option></mat-select></mat-form-field></div><div class="ajf-prop"><mat-form-field><textarea matInput formControlName="description" [placeholder]="\'Description\' | translate"></textarea></mat-form-field></div><div class="ajf-prop"><mat-form-field><input matInput formControlName="defaultValue" [placeholder]="\'Default value\' | translate"></mat-form-field></div><div class="ajf-prop"><div><label translate>Formula</label></div><div><button (click)="editFormula()" mat-raised-button [matTooltip]="curFormula"><div class="ajf-icon-cont"><mat-icon>edit</mat-icon><span>{{ curFormula }}</span></div></button></div></div><div class="ajf-prop"><mat-checkbox formControlName="notEmpty" translate>Not empty</mat-checkbox></div><ng-template [ngIf]="isNumericField((ne)?.node)"><div class="ajf-prop"><mat-form-field><input matInput formControlName="minValue" [placeholder]="\'Min value\' | translate"></mat-form-field></div><div class="ajf-prop"><mat-form-field><input matInput formControlName="maxValue" [placeholder]="\'Max value\' | translate"></mat-form-field></div><div class="ajf-prop"><mat-form-field><input matInput formControlName="minDigits" [placeholder]="\'Min digits\' | translate"></mat-form-field></div><div class="ajf-prop"><mat-form-field><input matInput formControlName="maxDigits" [placeholder]="\'Max digits\' | translate"></mat-form-field></div></ng-template><div class="ajf-prop"><div class="ajf-header"><label translate>Validation</label><mat-icon class="ajf-pointer" (click)="addValidationCondition()">add_circle_outline</mat-icon></div><div *ngIf="validationConditions == null || validationConditions.length == 0" class="ajf-validation-row ajf-emph" translate>No conditions</div><div class="ajf-validation-row" *ngFor="let validationCondition of validationConditions; let idx = index"><button (click)="editValidationCondition(idx)" mat-raised-button [matTooltip]="validationCondition.condition"><div class="ajf-icon-cont"><mat-icon>edit</mat-icon><span>{{ validationCondition.condition }}</span></div></button><mat-icon class="ajf-pointer" (click)="removeValidationCondition(idx)">remove_circle_outline</mat-icon></div></div><div class="ajf-prop"><mat-checkbox formControlName="notEmptyWarning" translate>Not empty warning</mat-checkbox></div><div class="ajf-prop"><div class="ajf-header"><label translate>Warnings</label><mat-icon class="ajf-pointer" (click)="addWarningCondition()">add_circle_outline</mat-icon></div><div *ngIf="warningConditions == null || warningConditions.length == 0" class="ajf-validation-row ajf-emph" translate>No warnings</div><div class="ajf-validation-row" *ngFor="let warningCondition of warningConditions; let idx = index"><button (click)="editWarningCondition(idx)" mat-raised-button [matTooltip]="warningCondition.condition"><div class="ajf-icon-cont"><mat-icon>edit</mat-icon><span>{{ warningCondition.condition }}</span></div></button><mat-icon class="ajf-pointer" (click)="removeWarningCondition(idx)">remove_circle_outline</mat-icon></div></div><div class="ajf-prop"><div><label translate>Go to next slide condition</label></div><div><button (click)="editNextSlideCondition()" mat-raised-button [matTooltip]="nextSlideCondition"><div class="ajf-icon-cont"><mat-icon>edit</mat-icon><span>{{ nextSlideCondition }}</span></div></button></div></div><ng-template [ngIf]="isFieldWithChoices((ne)?.node)"><div class="ajf-prop"><mat-form-field><mat-label translate>Choices origins</mat-label><mat-select formControlName="choicesOrigin" [placeholder]="\'Choices\' | translate"><mat-option *ngFor="let choicesOrigin of choicesOrigins" [value]="choicesOrigin.name">{{ choicesOrigin.label || choicesOrigin.name }}</mat-option></mat-select></mat-form-field></div><div class="ajf-prop"><div><label translate>Choices filter</label></div><div><button (click)="editChoicesFilter()" mat-raised-button [matTooltip]="curChoicesFilter"><div class="ajf-icon-cont"><mat-icon>edit</mat-icon><span>{{ curChoicesFilter }}</span></div></button></div></div><div class="ajf-prop"><mat-checkbox formControlName="forceExpanded" translate>Force expanded selection</mat-checkbox></div><div class="ajf-prop"><mat-checkbox formControlName="forceNarrow" translate>Force narrow selection</mat-checkbox></div><div class="ajf-prop"><div class="ajf-header"><label translate>Trigger selection</label><mat-icon class="ajf-pointer" (click)="addTriggerCondition()">add_circle_outline</mat-icon></div><div *ngIf="triggerConditions == null || triggerConditions.length == 0" class="ajf-validation-row ajf-emph" translate>No trigger condition</div><div class="ajf-validation-row" *ngFor="let triggerCondition of triggerConditions; let idx = index"><button (click)="editTriggerCondition(idx)" mat-raised-button [matTooltip]="triggerCondition"><div class="ajf-icon-cont"><mat-icon>edit</mat-icon><span>{{ triggerCondition }}</span></div></button><mat-icon class="pointer" (click)="removeTriggerCondition(idx)">remove_circle_outline</mat-icon></div></div></ng-template></ng-template></form></ng-container></ng-container>',styles:["ajf-fb-node-properties{display:block;padding:1em;position:relative}ajf-fb-node-properties mat-icon{cursor:pointer}ajf-fb-node-properties .ajf-header{display:flex;flex-direction:row;align-items:center;flex-wrap:nowrap}ajf-fb-node-properties .ajf-header>h3,ajf-fb-node-properties .ajf-header>label{flex:1 0 auto;margin-right:.5em}ajf-fb-node-properties .ajf-header>mat-icon{flex:0 0 auto;margin-left:.5em}ajf-fb-node-properties .ajf-disabled-overlay{position:absolute;top:0;right:0;bottom:0;left:0;opacity:.4;background-color:#fff}ajf-fb-node-properties .ajf-emph{font-style:italic}ajf-fb-node-properties [mat-raised-button]{margin:.5em 0}ajf-fb-node-properties [mat-raised-button].ajf-pointer{cursor:pointer}ajf-fb-node-properties [mat-raised-button] .ajf-icon-cont{display:flex;flex-direction:row;align-items:center}ajf-fb-node-properties [mat-raised-button] .ajf-icon-cont span{flex:1 1 auto;overflow:hidden;text-overflow:ellipsis;display:block;min-height:36px}ajf-fb-node-properties .ajf-validation-row{margin:.5em 0;display:flex;flex-direction:row;align-items:center}ajf-fb-node-properties .ajf-validation-row button{flex:1 1 auto}ajf-fb-node-properties .ajf-validation-row mat-icon{flex:0 0 auto}ajf-fb-node-properties .ajf-prop{margin:.5em 0}ajf-fb-node-properties [mat-raised-button],ajf-fb-node-properties mat-form-field,ajf-fb-node-properties mat-slider{width:100%}"],encapsulation:o.ViewEncapsulation.None,changeDetection:o.ChangeDetectionStrategy.OnPush}]}],yi.ctorParameters=function(){return[{type:K},{type:d.MatDialog},{type:j.FormBuilder}]},yi);function yi(i,e,t){var n=this;this._service=i,this._dialog=e,this._fb=t,this._fieldSizes=[{label:"Normal",value:"normal"},{label:"Small",value:"small"},{label:"Smaller",value:"smaller"},{label:"Tiny",value:"tiny"},{label:"Mini",value:"mini"}],this._choicesOrigins=[],this._conditionalBranches=[],this._validationConditions=[],this._warningConditions=[],this.isRepeatingContainerNode=F.isRepeatingContainerNode,this._visibilitySub=O.Subscription.EMPTY,this._conditionalBranchesSub=O.Subscription.EMPTY,this._formulaRepsSub=O.Subscription.EMPTY,this._choicesFilterSub=O.Subscription.EMPTY,this._formulaSub=O.Subscription.EMPTY,this._forceValueSub=O.Subscription.EMPTY,this._validationConditionsSub=O.Subscription.EMPTY,this._warningConditionsSub=O.Subscription.EMPTY,this._nextSlideConditionSub=O.Subscription.EMPTY,this._choicesOriginsSub=O.Subscription.EMPTY,this._triggerConditionsSub=O.Subscription.EMPTY,this._editConditionDialogSub=O.Subscription.EMPTY,this._editValidationConditionDialogSub=O.Subscription.EMPTY,this._editWarningConditionDialogSub=O.Subscription.EMPTY,this._editVisibilityEvt=new o.EventEmitter,this._editVisibilitySub=O.Subscription.EMPTY,this._editConditionalBranchEvt=new o.EventEmitter,this._editConditionalBranchSub=O.Subscription.EMPTY,this._editFormulaRepsEvt=new o.EventEmitter,this._editFormulaRepsSub=O.Subscription.EMPTY,this._editChoicesFilterEvt=new o.EventEmitter,this._editChoicesFilterSub=O.Subscription.EMPTY,this._editFormulaEvt=new o.EventEmitter,this._editFormulaSub=O.Subscription.EMPTY,this._editForceValueEvt=new o.EventEmitter,this._editForceValueSub=O.Subscription.EMPTY,this._editValidationConditionEvt=new o.EventEmitter,this._editValidationConditionSub=O.Subscription.EMPTY,this._addValidationConditionEvt=new o.EventEmitter,this._addValidationConditionSub=O.Subscription.EMPTY,this._removeValidationConditionEvt=new o.EventEmitter,this._removeValidationConditionSub=O.Subscription.EMPTY,this._editWarningConditionEvt=new o.EventEmitter,this._editWarningConditionSub=O.Subscription.EMPTY,this._addWarningConditionEvt=new o.EventEmitter,this._addWarningConditionSub=O.Subscription.EMPTY,this._removeWarningConditionEvt=new o.EventEmitter,this._removeWarningConditionSub=O.Subscription.EMPTY,this._editNextSlideConditionEvt=new o.EventEmitter,this._editNextSlideConditionSub=O.Subscription.EMPTY,this._editTriggerConditionEvt=new o.EventEmitter,this._editTriggerConditionSub=O.Subscription.EMPTY,this._addTriggerConditionEvt=new o.EventEmitter,this._addTriggerConditionSub=O.Subscription.EMPTY,this._removeTriggerConditionEvt=new o.EventEmitter,this._removeTriggerConditionSub=O.Subscription.EMPTY,this._saveEvt=new o.EventEmitter,this._saveSub=O.Subscription.EMPTY,this._nodeEntry=i.editedNodeEntry,this._choicesOriginsSub=i.choicesOrigins.subscribe(function(i){return n._choicesOrigins=i||[]}),this._enabled=this._nodeEntry.pipe(x.map(function(i){return null!=i})),this._initForm(),this._initVisibilityEdit(),this._initConditionalBranchEdit(),this._initFormulaRepsEdit(),this._initChoicesFilterEdit(),this._initFormulaEdit(),this._initForceValueEdit(),this._initValidationConditionEdit(),this._initAddValidationCondition(),this._initRemoveValidationCondition(),this._initWarningConditionEdit(),this._initAddWarningCondition(),this._initRemoveWarningCondition(),this._initNextSlideConditionEdit(),this._initTriggerConditionEdit(),this._initAddTriggerCondition(),this._initRemoveTriggerCondition(),this._initSave()}var Ci=(Object.defineProperty(Si.prototype,"nodeType",{get:function(){return this._nodeType},set:function(i){this._nodeType=i,this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Si.decorators=[{type:o.Component,args:[{selector:"ajf-fb-node-type-entry",template:'<ng-container *ngIf="nodeType"><mat-icon [fontSet]="nodeType.icon.fontSet" [fontIcon]="nodeType.icon.fontIcon"></mat-icon>{{ nodeType.label }}</ng-container>',styles:["ajf-fb-node-type-entry{display:block;padding:1em 1.5em}ajf-fb-node-type-entry mat-icon{vertical-align:middle}"],encapsulation:o.ViewEncapsulation.None,changeDetection:o.ChangeDetectionStrategy.OnPush}]}],Si.ctorParameters=function(){return[{type:o.ChangeDetectorRef}]},Si.propDecorators={nodeType:[{type:o.Input}]},Si);function Si(i){this._cdr=i}var ji=(Ei.decorators=[{type:o.NgModule,args:[{imports:[e.CommonModule,j.FormsModule,j.ReactiveFormsModule,t.DragDropModule,n.MatAutocompleteModule,a.MatButtonModule,r.MatCardModule,s.MatCheckboxModule,l.MatChipsModule,d.MatDialogModule,c.MatFormFieldModule,u.MatIconModule,p.MatInputModule,f.MatListModule,h.MatMenuModule,m.MatSelectModule,g.MatSidenavModule,b.MatSliderModule,v.MatTableModule,_.MatToolbarModule,y.MatTooltipModule,C.TranslateModule,S.AjfMonacoEditorModule,E.AjfNodeIconModule],declarations:[P,X,Y,ni,ei,ci,_i,Ci,ai,pi,hi,si],exports:[si],entryComponents:[X,ni,ai,pi,hi],providers:[K]}]}],Ei);function Ei(){}i.AjfFormBuilder=si,i.AjfFormBuilderModule=ji,i.AjfFormBuilderService=K,i.flattenNodes=$,i.a=P,i.b=X,i.c=Y,i.d=ni,i.e=ei,i.f=ci,i.g=_i,i.h=Ci,i.i=ai,i.j=pi,i.k=hi,Object.defineProperty(i,"__esModule",{value:!0})});
//# sourceMappingURL=material-form-builder.umd.min.js.map
